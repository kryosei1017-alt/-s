<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>LIFF Minimal｜ホーム</title>
<meta name="theme-color" content="#F6F3EE">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --radius:16px; --fs:13px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
    line-height:1.6;overflow-x:hidden;font-size:var(--fs);
    writing-mode:horizontal-tb!important;-webkit-writing-mode:horizontal-tb!important;text-orientation:mixed!important;
    touch-action:manipulation;
  }
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px 112px}
  header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px}
  .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ttl{font-weight:800;font-size:18px}
  .sub{color:var(--muted);font-size:var(--fs)}
  .pill{display:inline-flex;align-items:center;justify-content:center;min-width:56px;padding:6px 10px;border-radius:999px;background:#E7EFE7;color:#10381F;font-weight:700}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:14px 16px;border-radius:14px;font-size:var(--fs);cursor:pointer}
  .card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  .urlbox{padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:#FAFAF7;word-break:break-all}
  .stepper{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:6px 0 10px}
  .seg{height:10px;border-radius:999px;background:#E0E7E0}.seg.on{background:var(--accent)}
  /* モバイルは1列（全幅）・大画面のみ2列 */
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .grid2{grid-template-columns:1fr 1fr} }
  /* お知らせ */
  .notiList{list-style:none;margin:8px 0 0;padding:0;display:flex;flex-direction:column;gap:8px}
  .notiItem{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px 12px}
  .notiHead{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px}
  .tag{font-size:var(--fs);border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:#fff}
  .tag.sub{border-color:#86efac;background:#ecfdf5;color:#065f46}
  .tag.alert{border-color:#fecaca;background:#fff1f2;color:#7f1d1d}
  .time{font-size:var(--fs);color:#6B7280}
  /* タブバー */
  .tabbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center;font-size:var(--fs)}
  .tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="ttl">ホーム</div>
    <div class="sub" id="siteSub"></div>
    <span class="pill" id="envPill">—</span>
  </div>
</header>

<main class="wrap">
  <section>
    <!-- 進捗 -->
    <div class="card" id="progressCard" style="cursor:pointer">
      <div class="hrow" style="justify-content:space-between">
        <div>
          <div class="ttl" style="font-size:16px">進捗</div>
          <div class="sub">同意 → 決済 → 抽選</div>
        </div>
        <span class="pill" id="stepPill">未開始</span>
      </div>
      <div class="stepper"><div class="seg" id="seg1"></div><div class="seg" id="seg2"></div><div class="seg" id="seg3"></div></div>
      <div class="sub">タップして申込みに進む（別ページ）</div>
    </div>

    <!-- 招待URL -->
    <div class="card">
      <div class="ttl" style="font-size:16px">招待URL & 期限</div>
      <div class="urlbox" id="inviteUrl">— 未発行 —</div>
      <div class="hrow" style="justify-content:space-between;margin-top:10px">
        <div class="sub">残り <span id="remain">—</span></div>
        <div class="hrow" style="gap:8px">
          <button class="btn" id="shareBtn" disabled>共有</button>
          <button class="btn" id="copyBtn" disabled>URLをコピー</button>
        </div>
      </div>
    </div>

    <!-- クレジット（上）／お知らせ（下） -->
    <div class="grid2">
      <div class="card">
        <div class="ttl" style="font-size:16px">クレジット残高</div>
        <div style="font-size:32px;font-weight:800"><span id="credit">0</span> <span class="sub">pt</span></div>
        <div class="hrow" style="gap:8px;margin-top:8px">
          <button class="btn" id="chargeBtn">チャージ</button>
        </div>
        <div id="chargePanel" class="sub" style="display:none;margin-top:10px">
          <div class="hrow" style="gap:8px;align-items:center">
            <select id="chargeAmount">
              <option value="500">+500 pt</option>
              <option value="1000" selected>+1,000 pt</option>
              <option value="3000">+3,000 pt</option>
              <option value="5000">+5,000 pt</option>
            </select>
            <button class="btn" id="chargeDo">チャージ実行</button>
          </div>
          <div class="sub" style="margin-top:6px">※ デモ：即時で残高に反映します</div>
        </div>
      </div>

      <div class="card" id="newsCard">
        <div class="hrow" style="justify-content:space-between;align-items:center">
          <div class="ttl" style="font-size:16px">お知らせ</div>
          <button class="btn" id="refreshNoti">更新</button>
        </div>
        <ul id="notiList" class="notiList"></ul>
        <p id="notiEmpty" class="sub" style="margin-top:6px">まだお知らせはありません。</p>
      </div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <a class="active" href="index.html"><span class="tabicon"></span>ホーム</a>
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  window.addEventListener('gesturestart', e => e.preventDefault());
  const APP={ LIFF_ID:"2008178197-ELrxabO9", API:"https://script.google.com/macros/s/AKfycbzvAK9-fg02CJAmAO73XyuaN3HjF0k0bDncAxtWdn2MVOhTub1T9hT8bSs9XG0_4qxC/exec" };
  const STATE={ step:Number(localStorage.getItem("state.step")||"0"), credit:Number(localStorage.getItem("credit")||"0") };
  const $=s=>document.querySelector(s);

  // 個別ID生成
  function makeUID(src){ let h=5381; for(let i=0;i<src.length;i++){ h=((h<<5)+h) ^ src.charCodeAt(i); } const n=(h>>>0).toString(36).toUpperCase().padStart(7,'0'); return "GX-"+n; }
  function ensureAppUID(lineUserId){ if(lineUserId && !localStorage.getItem("appUID")) localStorage.setItem("appUID", makeUID(lineUserId)); }

  function setProgress(step){const labels=["未開始","同意","決済","抽選"];$("#stepPill").textContent=labels[step]||"未開始";[1,2,3].forEach(i=>$("#seg"+i).classList.toggle("on", i<=step));}
  function setCredit(v){ localStorage.setItem("credit", String(v)); $("#credit").textContent = v; }
  const getCredit = ()=> Number(localStorage.getItem("credit")||"0");

  // 通知
  const getNoti = ()=> JSON.parse(localStorage.getItem("notifications")||"[]");
  const setNoti = list => localStorage.setItem("notifications", JSON.stringify(list));
  const hasNoti = id => getNoti().some(n=>n.id===id);
  function addNoti(n){ const list=getNoti(); if(n.id && hasNoti(n.id)) return; list.unshift({id:n.id||String(Date.now()),ts:n.ts||Date.now(),type:n.type||"system",text:n.text||""}); setNoti(list); renderNoti(); }
  function mergeNoti(items){ if(!Array.isArray(items)) return; const map=new Map(getNoti().map(n=>[n.id,n])); for(const it of items){ if(it && it.id && !map.has(it.id)) map.set(it.id,it); } const merged=Array.from(map.values()).sort((a,b)=>(b.ts||0)-(a.ts||0)); setNoti(merged); renderNoti(); }
  function renderNoti(){
    const list=getNoti().sort((a,b)=>(b.ts||0)-(a.ts||0));
    const ul=$("#notiList"), empty=$("#notiEmpty");
    ul.innerHTML=""; if(!list.length){ empty.style.display="block"; return; } empty.style.display="none";
    for(const n of list){
      const li=document.createElement("li"); li.className="notiItem";
      const tagClass=n.type==="sub"?"tag sub":(n.type==="alert"?"tag alert":"tag");
      li.innerHTML=`<div class="notiHead"><span class="${tagClass}">${n.type==="sub"?"サブスク":n.type==="alert"?"お知らせ":"システム"}</span><span class="time">${new Date(n.ts||Date.now()).toLocaleString()}</span></div><div>${(n.text||"").replace(/\n/g,"<br>")}</div>`;
      ul.appendChild(li);
    }
  }
  async function fetchRemoteNoti(){ try{ const res=await fetch(APP.API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"pull_notifications"})}); const json=await res.json().catch(()=>null); if(json && Array.isArray(json.items)) mergeNoti(json.items); }catch(e){} }
  function ensureSubNoti(){ const sub=JSON.parse(localStorage.getItem("sub")||"{}"); if(!sub || !sub.active) return; const id="sub_active_"+(sub.since||"").slice(0,10); if(!getNoti().some(n=>n.id===id)){ const next=sub.nextRenewal?new Date(sub.nextRenewal):new Date(Date.now()+30*864e5); addNoti({id,type:"sub",text:`サブスクに加入しました（${sub.plan||"プラン"}）。\n次回更新日：${next.toLocaleDateString()}`}); } }

  // 招待URL表示
  function renderInviteOnHome(){
    const inv=JSON.parse(localStorage.getItem("invites")||"[]")[0];
    const box=$("#inviteUrl"), remain=$("#remain"), copyBtn=$("#copyBtn"), shareBtn=$("#shareBtn");
    if(!inv){ box.textContent="— 未発行 —"; remain.textContent="—"; copyBtn.disabled=shareBtn.disabled=true; return; }
    box.textContent=inv.url; copyBtn.disabled=shareBtn.disabled=false;
    const left=Math.max(0, inv.expiresAt - Date.now()); const h=Math.floor(left/36e5), m=Math.floor((left%36e5)/6e4);
    remain.textContent=`${h}時間 ${m}分`;
    copyBtn.onclick=async()=>{ try{ await navigator.clipboard.writeText(inv.url); copyBtn.textContent="コピー済み"; setTimeout(()=>copyBtn.textContent="URLをコピー",1000);}catch(e){} };
    shareBtn.onclick=()=>{ if(navigator.share){ navigator.share({title:"招待URL", text:"こちらからどうぞ", url:inv.url}); } else { alert("共有に未対応のブラウザです"); } };
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    $("#siteSub").textContent = location.hostname.replace(/^www\./,'');
    setProgress(STATE.step||0); $("#credit").textContent=STATE.credit;
    $("#progressCard").addEventListener("click", ()=> location.href="apply.html");
    const panel=$("#chargePanel"); $("#chargeBtn").addEventListener("click", ()=> panel.style.display=(panel.style.display==="none"?"block":"none"));
    $("#chargeDo").addEventListener("click", ()=>{ const add=Number($("#chargeAmount").value||0); const next=getCredit()+add; setCredit(next); addNoti({type:"system",text:`${add} ptをチャージしました。現在残高：${next} pt`}); });

    $("#refreshNoti").addEventListener("click", fetchRemoteNoti);
    renderNoti(); ensureSubNoti(); fetchRemoteNoti(); renderInviteOnHome();
    window.addEventListener("storage", e=>{ if(["notifications","sub","invites"].includes(e.key)) { renderNoti(); ensureSubNoti(); renderInviteOnHome(); } });

    try{
      await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser: true });
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
      $("#envPill").textContent = liff.isInClient()? "LINE内":"外部ブラウザ";
      const prof = await liff.getProfile();
      ensureAppUID(prof.userId||"");
    }catch(e){ console.warn(e); }
  });
</script>
</body>
</html>
