<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>LIFF Minimal｜ホーム</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
:root{ --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59; --border:#E5E7EB; --radius:16px; --fs:13px; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;line-height:1.6;overflow-x:hidden;font-size:var(--fs);touch-action:manipulation;}
.wrap{max-width:720px;margin:0 auto;padding:12px 16px 112px}
header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px}
.hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ttl{font-weight:800;font-size:18px}
.sub{color:var(--muted)}
.pill{display:inline-flex;align-items:center;justify-content:center;min-width:56px;padding:6px 10px;border-radius:999px;background:#E7EFE7;color:#10381F;font-weight:700}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:12px 14px;border-radius:14px;font-size:14px;cursor:pointer}
.card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
.urlbox{padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:#FAFAF7;word-break:break-all}
.stepper{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:6px 0 10px}
.seg{height:10px;border-radius:999px;background:#E0E7E0}.seg.on{background:var(--accent)}
.grid1{display:grid;grid-template-columns:1fr;gap:12px}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
.tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center}
.tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
.tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
.notice-list{display:flex;flex-direction:column;gap:10px;max-height:260px;overflow:auto;padding-right:6px}
.notice{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
.notice .note{font-weight:700;color:#0b5b42;margin-right:8px}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="ttl">ホーム</div>
    <div class="sub" id="siteSub"></div>
    <span class="pill" id="envPill">—</span>
  </div>
</header>

<main class="wrap">
  <section class="card" id="progressCard" style="cursor:pointer">
    <div class="hrow" style="justify-content:space-between">
      <div>
        <div class="ttl" style="font-size:17px">進捗</div>
        <div class="sub">同意 → 決済 → 抽選</div>
      </div>
      <span class="pill" id="stepPill">未開始</span>
    </div>
    <div class="stepper"><div class="seg" id="seg1"></div><div class="seg" id="seg2"></div><div class="seg" id="seg3"></div></div>
    <div class="sub">タップして申込みに進む（別ページ）</div>
  </section>

  <section class="card">
    <div class="ttl" style="font-size:17px">招待URL & 期限</div>
    <div class="urlbox" id="inviteUrl">— 未発行 —</div>
    <div class="hrow" style="justify-content:space-between;margin-top:10px">
      <div class="sub">残り <span id="remain">—</span></div>
      <div class="hrow" style="gap:8px">
        <button class="btn" id="shareBtn" disabled>共有</button>
        <button class="btn" id="copyBtn" disabled>URLをコピー</button>
      </div>
    </div>
  </section>

  <section class="grid1">
    <div class="card">
      <div class="ttl" style="font-size:17px">クレジット残高</div>
      <div style="font-size:28px;font-weight:800"><span id="credit">0</span> <span class="sub">pt</span></div>
      <div class="hrow" style="gap:8px;margin-top:8px">
        <button class="btn" id="chargeBtn">チャージ</button>
      </div>
      <div id="chargePanel" class="sub" style="display:none;margin-top:10px">
        <div class="hrow" style="gap:8px;align-items:center">
          <select id="chargeAmount">
            <option value="500">+500 pt</option>
            <option value="1000" selected>+1,000 pt</option>
            <option value="3000">+3,000 pt</option>
          </select>
          <button class="btn" id="chargeDo">チャージ実行</button>
        </div>
        <div class="sub" style="margin-top:6px">※ デモ：即時で残高に反映</div>
      </div>
    </div>

    <div class="card">
      <div class="ttl" style="font-size:17px">お知らせ</div>
      <div class="hrow" style="justify-content:flex-end"><button class="btn" id="notiReload">更新</button></div>
      <div id="notices" class="notice-list"></div>
    </div>
  </section>
</main>

<nav class="tabbar">
  <a class="active" href="index.html"><span class="tabicon"></span>ホーム</a>
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
const APP={ LIFF_ID:"2008178197-ELrxabO9" };
const STATE={ step:Number(localStorage.getItem("state.step")||"0"), credit:Number(localStorage.getItem("credit")||"0") };
const $=s=>document.querySelector(s);

function ensureUID(){
  let uid = localStorage.getItem('appUID');
  if(!uid){
    uid = 'GX-' + Math.random().toString(36).slice(2,6).toUpperCase()
            + '-' + Date.now().toString().slice(-6);
    localStorage.setItem('appUID', uid);
  }
}

function setProgress(step){
  const labels=["未開始","同意","決済","抽選"];
  $("#stepPill").textContent=labels[step]||"未開始";
  [1,2,3].forEach(i=>$("#seg"+i).classList.toggle("on", i<=step));
}
function setCredit(v){ localStorage.setItem("credit", String(v)); $("#credit").textContent = v; }

function renderNoti(){
  const box=$("#notices"); box.innerHTML="";
  const list = JSON.parse(localStorage.getItem('notices')||'[]');
  list.forEach(n=>{
    const el=document.createElement('div');
    el.className='notice';
    el.innerHTML=`<div class="sub">${n.ts||''}</div><div><span class="note">${n.type||''}</span>${n.text||''}</div>`;
    box.appendChild(el);
  });
}
function addNoti(obj){
  const list = JSON.parse(localStorage.getItem('notices')||'[]');
  list.unshift({ts:new Date().toLocaleString(), ...obj});
  localStorage.setItem('notices', JSON.stringify(list.slice(0,30)));
  renderNoti();
}

document.addEventListener("DOMContentLoaded", async ()=>{
  $("#siteSub").textContent = location.hostname.replace(/^www\./,'');
  setProgress(STATE.step||0);
  $("#credit").textContent = STATE.credit;
  renderNoti();

  $("#progressCard").addEventListener("click", ()=> location.href="apply.html");

  const panel = $("#chargePanel");
  $("#chargeBtn").addEventListener("click", ()=> panel.style.display = (panel.style.display==="none"?"block":"none"));
  $("#chargeDo").addEventListener("click", ()=>{
    const add = Number($("#chargeAmount").value||0);
    const cur = Number(localStorage.getItem("credit")||"0");
    const next = cur + add; setCredit(next);
    addNoti({type:"system", text:`${add}pt チャージしました。現在残高: ${next}pt`});
    SYNC.syncNow();
  });
  $("#notiReload").addEventListener("click", renderNoti);

  try{
    await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
    $("#envPill").textContent = liff.isInClient()? "LINE内":"外部ブラウザ";

    ensureUID();
    const profile = await liff.getProfile();
    await SYNC.syncOnLogin(profile); // ←ここでUsersに反映
  }catch(e){ console.warn(e); }
});
</script>
</body>
</html>
