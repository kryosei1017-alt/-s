<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>LIFF Minimal｜マイページ</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- ★ 必ず注入 -->
<script>
window.APP = {
  LIFF_ID: '2008178197-ELrxabO9',
  CHANNEL_ID: '2008178197',
  API_URL: 'https://script.google.com/macros/s/AKfycbz6_13624N9r9R4FR0T0LnS1OB3mZ3uTTr1XV0o5AmU3yWHl7JLSwn3Guh7fHyPgK35/exec'
};
</script>

<!-- ★ 実ファイル名に合わせる -->
<script src="api-4.js"></script>

<style>
  :root{--bg:#F6F3EE;--card:#FFF;--ink:#1F2937;--muted:#6B7280;--accent:#0C7C59;--border:#E5E7EB;--r:16px;--tab:88px}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;line-height:1.6;overflow-x:hidden}
  header{position:sticky;top:0;z-index:10;background:var(--bg);padding:12px 16px 8px}
  .ttl{font-weight:800;font-size:18px}.sub{color:#6B7280;font-size:12px}
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px calc(var(--tab) + 20px)}
  .card{background:#FFF;border:1px solid var(--border);border-radius:16px;padding:14px 16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;border-radius:14px;font-size:16px;padding:10px 14px;cursor:pointer}
  .btn.small{font-size:13px;padding:8px 12px;border-radius:12px}
  .row{display:flex;align-items:center;gap:10px}.between{justify-content:space-between}
  .kv{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed var(--border)}
  .label{color:#6B7280}
  .pill{display:inline-flex;align-items:center;justify-content:center;min-width:56px;padding:6px 10px;border-radius:999px;background:#E7EFE7;color:#10381F;font-weight:700}
  .ok{background:#E7F5ED;color:#065F46}.warn{background:#FEF3C7;color:#92400E}.gray{background:#F3F4F6;color:#111827}
  input,select,textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;font-size:16px}
  textarea{min-height:90px}
  .urlbox{padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:#FAFAF7;word-break:break-all}
  nav.tab{position:fixed;left:0;right:0;bottom:0;height:var(--tab);background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tab a{flex:1;text-decoration:none;color:#6B7280;padding:16px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;text-align:center}
  .i{width:22px;height:22px;border-radius:6px;background:#CBD5CB}.tab .active{color:#0d3a23;font-weight:800}.tab .active .i{background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="ttl">マイページ</div>
  <div class="sub" id="siteSub"></div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row between">
      <div class="row" style="gap:8px"><div class="label">個別ID</div><div id="uidText" style="font-weight:700">—</div></div>
      <button id="copyUid" class="btn small">コピー</button>
    </div>
  </section>

  <section class="card" id="profView">
    <div class="row between"><div style="font-weight:700">プロフィール</div><button id="editBtn" class="btn small">編集</button></div>
    <div class="kv"><div class="label">ニックネーム</div><div id="v_name">—</div></div>
    <div class="kv"><div class="label">年齢</div><div id="v_age">—</div></div>
    <div class="kv"><div class="label">エリア</div><div id="v_area">—</div></div>
  </section>

  <!-- 編集フォームは省略（既存のまま） -->

  <section class="card">
    <div class="row between"><div style="font-weight:700">本人確認</div><span id="kycBadge" class="pill gray">未確認</span></div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="asFemale" class="btn small">女性として確認済みにする</button>
      <button id="asMale" class="btn small">男性として確認済みにする</button>
    </div>
    <p class="note">※ デモ切替。本番は外部eKYC連携。</p>
  </section>

  <section class="card">
    <div class="row between"><div style="font-weight:700">クレジット残高</div><div><b id="credit">0</b> pt</div></div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="chargePlus" class="btn small">+1000pt</button>
      <button id="chargeMinus" class="btn small">-1000pt</button>
    </div>
  </section>

  <section class="card">
    <div style="font-weight:700">招待URL</div>
    <div class="urlbox" id="currentInvite">— 現在の招待：未発行 —</div>
    <div class="row" style="gap:8px;margin-top:8px"><button id="copyInvite" class="btn small">現在の招待URLをコピー</button></div>
    <div style="font-weight:700;margin-top:10px">履歴</div>
    <div id="histList" class="urlbox">— まだ履歴がありません —</div>
  </section>

  <section class="card">
    <div class="row between"><div style="font-weight:700">お知らせ</div><button id="addNoti" class="btn small">テスト通知を追加</button></div>
    <div id="notiList" style="margin-top:8px" class="urlbox">— まだお知らせはありません —</div>
  </section>
</main>

<nav class="tab">
  <a href="apply-4.html"><span class="i"></span>申込み</a>
  <a class="active" href="mypage-4.html"><span class="i"></span>マイページ</a>
</nav>

<script>
  const $=s=>document.querySelector(s);
  const j=k=>JSON.parse(localStorage.getItem(k)||'null');
  const g=k=>localStorage.getItem(k);

  function hash36(str){let h=0;for(let i=0;i<str.length;i++){h=(h*31+str.charCodeAt(i))>>>0;}return('0000000'+h.toString(36).toUpperCase()).slice(-7);}
  function ensureUIDSync(){let uid=g('appUID')||g('uid');if(!uid){uid='GX-'+Math.random().toString(36).slice(-7).toUpperCase();}localStorage.setItem('appUID',uid);localStorage.setItem('uid',uid);return uid;}
  async function ensureUIDAsync(){let uid=g('appUID')||g('uid');if(!uid&&window.liff&&liff.getProfile){try{const pf=await liff.getProfile();uid='GX-'+hash36((pf.userId||'')+'|'+(location.hostname||''));}catch(e){}if(uid){localStorage.setItem('appUID',uid);localStorage.setItem('uid',uid);}}if(!uid)uid=ensureUIDSync();return uid;}
  function renderUID(){$('#uidText').textContent=g('appUID')||g('uid')||'—';}
  function renderProfile(){const p=j('profile')||{};$('#v_name').textContent=(p.name??g('prof.name')??'—')||'—';$('#v_age').textContent=(p.age??g('prof.age')??'—')||'—';$('#v_area').textContent=(p.area??g('prof.area')??'—')||'—';}
  function renderKyc(){const v=g('kyc.verified')==='true';const gender=g('kyc.gender')||'';const el=$('#kycBadge');el.textContent=v?(gender==='female'?'本人確認済（女性）':gender==='male'?'本人確認済（男性）':'本人確認済'):'未確認';el.className='pill '+(v?'ok':'warn');}
  function renderCredit(){$('#credit').textContent=Number(g('credit')||0);}
  function getNoti(){return j('noti.items')||j('notifications')||[];}
  function setNoti(arr){localStorage.setItem('noti.items',JSON.stringify(arr));localStorage.setItem('notifications',JSON.stringify(arr));}
  function renderNoti(){const arr=getNoti();$('#notiList').innerHTML=arr.length?arr.map(n=>`<div>・${(n.date||'').toString()}：${n.text||''}</div>`).join(''):'— まだお知らせはありません —';}
  function formatRemain(iso){if(!iso)return'—';const d=new Date(iso+'T00:00:00'),t=new Date();d.setHours(0,0,0,0);t.setHours(0,0,0,0);const diff=Math.ceil((d-t)/86400000);return diff>=0?`残り ${diff}日`:'期限切れ';}
  function renderInvites(){const cur=j('invite.current')||{url:'',expire:''};$('#currentInvite').innerHTML=cur.url?(`<div>現在の招待URL：<b>${cur.url}</b></div><div class="note">期限：${cur.expire||'—'}（${formatRemain(cur.expire)}）</div>`):'— 現在の招待：未発行 —';const hist=j('invite.history')||[];$('#histList').innerHTML=hist.length?hist.map(x=>`<div>・${x.date||''}　${x.url||''}</div>`).join(''):'— まだ履歴がありません —';}

  $('#copyUid').addEventListener('click',async()=>{try{await navigator.clipboard.writeText($('#uidText').textContent||'');alert('個別IDをコピーしました');}catch{}});
  $('#asFemale').addEventListener('click',()=>{localStorage.setItem('kyc.verified','true');localStorage.setItem('kyc.gender','female');renderKyc();});
  $('#asMale').addEventListener('click',()=>{localStorage.setItem('kyc.verified','true');localStorage.setItem('kyc.gender','male');renderKyc();});
  $('#addNoti').addEventListener('click',()=>{const arr=getNoti();arr.unshift({date:new Date().toISOString().slice(0,19).replace('T',' '),text:'テスト通知'});setNoti(arr);renderNoti();});
  $('#chargePlus').addEventListener('click',()=>{localStorage.setItem('credit',String(Number(g('credit')||0)+1000));renderCredit();});
  $('#chargeMinus').addEventListener('click',()=>{localStorage.setItem('credit',String(Math.max(0,Number(g('credit')||0)-1000)));renderCredit();});

  document.addEventListener('DOMContentLoaded',async()=>{
    $('#siteSub').textContent=location.hostname.replace(/^www\./,'');
    try{
      await liff.init({liffId:(window.APP&&APP.LIFF_ID)||'',withLoginOnExternalBrowser:true});
      if(!liff.isLoggedIn()){liff.login({redirectUri:location.href});return;}
      if(window.SYNC&&SYNC.syncOnLogin){const prof=await liff.getProfile();await SYNC.syncOnLogin(prof);}
    }catch(e){console.warn(e);}
    await ensureUIDAsync();
    renderUID();renderProfile();renderKyc();renderCredit();renderInvites();renderNoti();
  });
</script>
</body>
</html>
