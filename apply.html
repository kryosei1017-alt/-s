<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>LIFF Minimal｜申込み</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFFFFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --tabbarH:88px; --fs:14px; --progress:#DDE8DD; --progressOn:#BFD5C4;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
    line-height:1.6;font-size:var(--fs);overflow-x:hidden;touch-action:manipulation;
    writing-mode:horizontal-tb!important;-webkit-writing-mode:horizontal-tb!important;text-orientation:mixed!important;
  }
  header{position:sticky;top:0;z-index:10;background:var(--bg);padding:12px 16px 0}
  .ttl{font-weight:800;font-size:18px}
  .sub{color:var(--muted);font-size:12px;margin-top:2px}
  .crumbs{color:#6B7280;font-size:12px;margin-top:6px}
  .crumbs b{color:#111827}
  .wrap{max-width:720px;margin:0 auto;padding:10px 16px calc(var(--tabbarH) + 20px)}

  /* 進捗（4本） */
  .progress{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:10px 0 12px}
  .bar{height:10px;border-radius:999px;background:var(--progress)}

  /* カード・フォーム */
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  .sec-title{font-weight:800;margin-bottom:6px}
  .field{display:flex;flex-direction:column;gap:8px;margin:12px 0}
  .label{font-weight:700}
  select,input,textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;font-size:16px}
  textarea{min-height:84px}

  /* ボタン */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;border-radius:18px;font-size:16px;padding:12px 16px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.ghost{background:#fff;color:#111827;border-color:var(--border)}
  .note{color:#6B7280;font-size:12px;margin-top:10px}

  /* —— 下タブ（マイページと同一デザイン／2タブ） —— */
  nav.tabbar{
    position:fixed;left:0;right:0;bottom:0;height:var(--tabbarH);
    background:rgba(255,255,255,.96);backdrop-filter:blur(10px);
    border-top:1px solid var(--border);display:flex;z-index:30;
    padding-bottom:calc(env(safe-area-inset-bottom) + 8px)
  }
  .tabbar a{
    flex:1;text-decoration:none;color:#6B7280;padding:16px 6px;
    display:flex;flex-direction:column;gap:6px;align-items:center;text-align:center
  }
  .tabicon{width:22px;height:22px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}
  .tabbar .active .tabicon{background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="ttl">申込み</div>
  <div class="sub" id="siteSub"></div>
  <div class="crumbs"><b>申込み</b>　入力 → 同意 → 決済 → 抽選</div>
</header>

<main class="wrap">
  <!-- 4分割プログレス -->
  <div class="progress" aria-hidden="true">
    <div class="bar" id="p1"></div>
    <div class="bar" id="p2"></div>
    <div class="bar" id="p3"></div>
    <div class="bar" id="p4"></div>
  </div>

  <!-- 入力 -->
  <section class="card" id="secInput">
    <div class="sec-title">入力</div>

    <div class="field">
      <div class="label">人数</div>
      <select id="selMembers">
        <option value="2:2" selected>2対2</option>
        <option value="3:3">3対3</option>
        <option value="4:4">4対4</option>
      </select>
    </div>

    <div class="field">
      <div class="label">エリア</div>
      <select id="selArea">
        <option value="" selected disabled>選択してください</option>
        <option>東京</option><option>横浜</option><option>千葉</option><option>埼玉</option>
        <option>名古屋</option><option>大阪</option><option>福岡</option>
      </select>
    </div>

    <div class="field">
      <div class="label">希望年齢層</div>
      <select id="selAgeBand">
        <option>18-19</option><option selected>20-24</option><option>25-29</option>
        <option>30-34</option><option>35-39</option><option>40-49</option><option>50+</option>
      </select>
    </div>

    <div class="field">
      <div class="label">自己評価スコア（0〜100）</div>
      <input id="selfScore" type="number" inputmode="numeric" min="0" max="100" value="50" />
    </div>

    <div class="field">
      <div class="label">友だちの個別ID（カンマ区切り）</div>
      <input id="friendIds" placeholder="例） GX-ABC1234,GX-XYZ9KLM" />
    </div>

    <div class="grid2">
      <button id="backBtn" class="btn ghost">戻る</button>
      <button id="toAgree" class="btn primary">同意へ進む</button>
    </div>

    <div class="note">※ 本人確認が未完了／プロフィール必須項目未入力だと先へ進めません。</div>
  </section>

  <!-- 同意 -->
  <section class="card" id="secAgree" style="display:none">
    <div class="sec-title">同意</div>
    <div class="field"><label><input id="chkAgree" type="checkbox" /> 利用規約に同意する</label></div>
    <div class="grid2">
      <button id="backToInput" class="btn ghost">戻る</button>
      <button id="toPay" class="btn primary" disabled>決済へ</button>
    </div>
  </section>

  <!-- 決済 -->
  <section class="card" id="secPay" style="display:none">
    <div class="sec-title">決済</div>
    <div class="field"><label><input type="radio" name="pay" id="payOnce" checked /> 単発（男性 -1000pt / 女性 0pt）</label></div>
    <div class="field"><label><input type="radio" name="pay" id="paySub" /> サブスク（初回 -1980pt → 次回以降 0pt）</label></div>
    <div class="grid2">
      <button id="backToAgree" class="btn ghost">戻る</button>
      <button id="confirmPay" class="btn primary">支払う</button>
    </div>
  </section>

  <!-- 抽選 -->
  <section class="card" id="secDraw" style="display:none">
    <div class="sec-title">抽選</div>
    <div>抽選中…</div>
  </section>
</main>

<!-- 下部タブ（マイページと同じ2タブ） -->
<nav class="tabbar">
  <a class="active" href="apply.html"><span class="tabicon"></span>申込み</a>
  <a href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  const $=s=>document.querySelector(s);
  const j=(k)=>JSON.parse(localStorage.getItem(k)||'null');
  const g=(k)=>localStorage.getItem(k);

  // 見た目の進捗バー（入力=1, 同意=2, 決済=3, 抽選=4）
  function paintProgress(step){
    [1,2,3,4].forEach(i=>{
      const el=$('#p'+i); if(!el) return;
      el.style.background = i<=step ? 'var(--progressOn)' : 'var(--progress)';
    });
  }
  function show(id){
    ['secInput','secAgree','secPay','secDraw'].forEach(x=>{
      const el=document.getElementById(x);
      if(el) el.style.display = (x===id?'block':'none');
    });
    const stepMap={secInput:1,secAgree:2,secPay:3,secDraw:4};
    paintProgress(stepMap[id]||1);
  }

  function canProceed(){
    const p=j('profile')||{};
    const okProf = !!(p.name && p.age && p.area);
    const okKyc  = (g('kyc.verified')==='true');
    return okProf && okKyc;
  }

  function currentPay(){
    const male = (g('kyc.gender')==='male');
    const female = (g('kyc.gender')==='female');
    const sub = $('#paySub').checked;
    let pay = 0;
    if(female){ pay = 0; }
    else if(male){ pay = sub?1980:1000; }
    else { pay = 1000; }
    return pay;
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    $('#siteSub').textContent = location.hostname.replace(/^www\./,'');

    /* === 無限ログイン防止つき LIFF 初期化（UI非変更） === */
    try{
      const LIFF_ID = (window.APP&&APP.LIFF_ID) || '2008178197-ELrxabO9';
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isInClient() && !liff.isLoggedIn()){
        if (!sessionStorage.getItem('liff.login.tried')){
          sessionStorage.setItem('liff.login.tried','1');
          liff.login({ redirectUri: location.href });
        }
        return; // 復帰後に続行
      }
      // displayName を保存（UIは触らない＝見た目維持）
      try{
        const prof = await liff.getProfile();
        if (prof && prof.displayName){ localStorage.setItem('line.displayName', prof.displayName); }
      }catch(_){}
    }catch(e){ console.warn(e); }

    // 画面遷移
    $('#backBtn').addEventListener('click', ()=>history.length>1?history.back():location.replace('index.html'));
    $('#toAgree').addEventListener('click', ()=>{
      if(!canProceed()){
        alert('本人確認の完了と、プロフィール（ニックネーム・年齢・エリア）の入力が必要です。マイページで設定してください。');
        location.href='mypage.html';
        return;
      }
      show('secAgree');
    });
    $('#chkAgree').addEventListener('change',()=>$('#toPay').disabled=!$('#chkAgree').checked);
    $('#backToInput').addEventListener('click',()=>show('secInput'));
    $('#toPay').addEventListener('click',()=>{ show('secPay'); currentPay(); });
    ['payOnce','paySub'].forEach(id=>$('#'+id).addEventListener('change', currentPay));
    $('#backToAgree').addEventListener('click',()=>show('secAgree'));

    // 決済→GAS送信
    $('#confirmPay').addEventListener('click', async ()=>{
      const pay = currentPay();
      let credit = Number(g('credit')||0);
      credit = Math.max(0, credit - pay);
      localStorage.setItem('credit', String(credit));

      // サブスク加入（デモ通知）
      if($('#paySub').checked && pay>0){
        const next = new Date(); next.setMonth(next.getMonth()+1);
        localStorage.setItem('sub', JSON.stringify({active:true, plan:'basic', since:new Date().toISOString().slice(0,10), nextRenewal: next.toISOString().slice(0,10)}));
        const keyA='noti.items', keyB='notifications';
        const items = JSON.parse(localStorage.getItem(keyA)||localStorage.getItem(keyB)||'[]');
        items.unshift({date:new Date().toISOString().slice(0,19).replace('T',' '), text:`サブスク加入：次回更新 ${next.toISOString().slice(0,10)}`});
        localStorage.setItem(keyA, JSON.stringify(items)); localStorage.setItem(keyB, JSON.stringify(items));
      }

      // GASへ送信
      const payload = {
        action:'apply',
        timestamp:new Date().toISOString(),
        source:location.hostname,
        uid: localStorage.getItem('uid')||'',
        members: $('#selMembers').value,
        area: $('#selArea').value,
        ageBand: $('#selAgeBand').value,
        selfScore: $('#selfScore').value,
        friendIds: $('#friendIds').value,
        pay: pay
      };
      try{
        const endpoint = (window.APP&&APP.GAS_ENDPOINT) || 'https://script.google.com/macros/s/AKfycbzvAK9-fg02CJAmAO73XyuaN3HjF0k0bDncAxtWdn2MVOhTub1T9hT8bSs9XG0_4qxC/exec';
        const res = await fetch(endpoint, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), mode:'cors'
        });
        if(!res.ok) throw new Error('bad');
      }catch(e){
        console.warn(e);
        alert('サーバー送信に失敗しました。URL・GAS公開設定・CORSを確認してください。');
        return;
      }

      show('secDraw');
    });

    // 初期表示
    show('secInput');
  });
</script>
</body>
</html>
