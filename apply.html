<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1, minimum-scale=1" />
<title>LIFF Minimal｜申込み</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --radius:16px; --fs:14px; --fs-sm:12.5px; --fs-lg:18px;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
    line-height:1.6; font-size:var(--fs); overflow-x:hidden;
    -webkit-text-size-adjust:100%;
  }
  html{ writing-mode:horizontal-tb !important; -webkit-writing-mode:horizontal-tb !important; text-orientation:mixed !important; }
  *{ touch-action:manipulation; }

  .wrap{ max-width:720px; margin:0 auto; padding:12px 16px 112px; }
  header{ position:sticky; top:0; z-index:20; background:var(--bg); padding:10px 16px; }
  .hrow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .ttl{ font-weight:800; font-size:var(--fs-lg); }
  .sub{ color:var(--muted); font-size:var(--fs-sm); }

  .card{ background:#FFF; border:1px solid var(--border); border-radius:var(--radius);
         padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.04); margin-bottom:12px; }
  .row{ display:flex; align-items:center; gap:10px; }
  .row.spread{ justify-content:space-between; }
  .btn{ appearance:none; border:1px solid var(--border); background:#fff; color:#111827;
        padding:14px 16px; border-radius:14px; cursor:pointer; font-size:var(--fs); }
  .btn.primary{ background:var(--accent); color:#fff; border-color:transparent; }
  .btn.small{ padding:10px 12px; font-size:var(--fs-sm); }

  .stepper{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin:8px 0 14px; }
  .seg{ height:10px; border-radius:999px; background:#E0E7E0; }
  .seg.on{ background:var(--accent); }

  label.title{ font-weight:700; display:block; margin:6px 0 6px; }
  input, select, textarea{
    width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff; font-size:var(--fs);
  }
  .hint{ font-size:var(--fs-sm); color:var(--muted); }
  .dashed{ border:1px dashed var(--border); border-radius:12px; background:#FAFAF7; padding:12px; }
  .radios{ display:grid; gap:10px; }
  .radioRow{ display:flex; align-items:center; gap:12px; padding:12px; border:1px dashed var(--border); border-radius:12px; background:#FAFAF7; }
  .pill{ display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border-radius:999px; font-weight:700; }
  .pill.warn{ background:#FEF3C7; color:#92400E; }
  .pill.free{ background:#E7F5ED; color:#065F46; }

  .tabbar{ position:fixed; left:0; right:0; bottom:0; height:96px; background:rgba(255,255,255,.96);
           backdrop-filter:blur(10px); border-top:1px solid var(--border); display:flex; z-index:30;
           padding-bottom:calc(env(safe-area-inset-bottom) + 8px) }
  .tabbar a{ flex:1; text-decoration:none; color:#6B7280; padding:18px 6px; display:flex; flex-direction:column; gap:6px; align-items:center; min-height:76px; text-align:center }
  .tabicon{ width:24px; height:24px; border-radius:6px; background:#CBD5CB }
  .tabbar .active{ color:#0d3a23; font-weight:800 } .tabbar .active .tabicon{ background:var(--accent) }
  .actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
</style>
</head>
<body>
<header>
  <div class="hrow"><div class="ttl">申込み</div><div class="sub">入力 → 同意 → 決済 → 抽選</div></div>
</header>

<main class="wrap">

  <div class="stepper">
    <div class="seg" id="s1"></div>
    <div class="seg" id="s2"></div>
    <div class="seg" id="s3"></div>
    <div class="seg" id="s4"></div>
  </div>

  <!-- 入力 -->
  <section class="card" id="secInput">
    <div class="ttl" style="font-size:16px">入力</div>

    <label class="title">人数</label>
    <select id="inPairs">
      <option value="2x2">2対2</option>
      <option value="3x3">3対3</option>
    </select>

    <label class="title">エリア</label>
    <select id="inArea">
      <option value="">選択してください</option>
      <option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option>
      <option>名古屋</option><option>大阪</option><option>福岡</option>
    </select>

    <label class="title">希望年齢層</label>
    <select id="inAgeBand">
      <option>18-19</option><option selected>20-24</option><option>25-29</option>
      <option>30-34</option><option>35-39</option><option>40-49</option>
    </select>

    <label class="title">自己評価スコア（0〜100）</label>
    <input id="inSelf" type="number" min="0" max="100" value="50" />

    <label class="title">友だちの個別ID（カンマ区切り）</label>
    <input id="inFriends" placeholder="例）GX-ABC1234,GX-XYZ9KLM" />

    <div class="actions" style="margin-top:12px">
      <button class="btn" onclick="location.href='index.html'">戻る</button>
      <button class="btn primary" id="toAgree">同意へ進む</button>
    </div>
    <p class="hint">※ 本人確認が未完了／プロフィール必須（ニックネーム・年齢・エリア）未入力だと先へ進めません。</p>
  </section>

  <!-- 同意 -->
  <section class="card" id="secAgree" style="display:none">
    <div class="ttl" style="font-size:16px">同意</div>
    <div class="dashed" style="margin-top:8px">
      <b>本人確認について：</b> 必要に応じて身分証とセルフィーの提出をお願いする場合があります。年齢・なりすまし対策のためです。
    </div>

    <a class="btn small" href="terms.html" target="_blank" rel="noopener">利用規約を開く</a>

    <div class="dashed" style="margin-top:10px">
      <label style="display:flex; align-items:center; gap:10px; margin:0;">
        <input id="chkAgree" type="checkbox" />
        <b>利用規約に同意する</b>
      </label>
    </div>

    <div class="actions" style="margin-top:12px">
      <button class="btn" id="backToInput">戻る</button>
      <button class="btn primary" id="toPay" disabled>決済へ進む</button>
    </div>
  </section>

  <!-- 決済 -->
  <section class="card" id="secPay" style="display:none">
    <div class="ttl" style="font-size:16px">決済</div>
    <p class="sub">クレジット残高から差し引きます。</p>

    <div id="femaleFree" class="pill free" style="display:none; margin:8px 0;">女性は無料です（0 pt）</div>

    <div class="radios" id="payOptions">
      <label class="radioRow"><input type="radio" name="pay" value="one" checked />
        <div><b>単発で支払う</b>（- 1000 pt）</div></label>
      <label class="radioRow"><input type="radio" name="pay" value="sub" />
        <div><b>サブスクに加入して支払う</b>（- 1980 pt）<br/><span class="hint">※ 次回以降は 0 pt</span></div></label>
    </div>

    <div class="card" style="border:1px dashed var(--border); background:#FAFAF7; margin-top:12px;">
      <div class="row spread"><div>現在の残高</div><div><b><span id="bal">0</span> pt</b></div></div>
      <div class="row spread"><div>今回の支払い</div><div><b>- <span id="payNow">0</span> pt</b></div></div>
      <hr style="border:none; border-top:1px solid var(--border); margin:10px 0;">
      <div class="row spread"><div><b>決済後の残高</b></div><div><b><span id="balAfter">0</span> pt</b></div></div>
    </div>

    <div id="lack" class="pill warn" style="display:none; margin:10px 0;">残高が不足しています。ホームでチャージしてください。</div>

    <div class="actions" style="margin-top:12px">
      <button class="btn" id="backToAgree">戻る</button>
      <button class="btn" id="goCharge" style="display:none" onclick="location.href='index.html'">ホームでチャージ</button>
      <button class="btn primary" id="confirmPay">この内容で確定</button>
    </div>
  </section>

  <!-- 抽選（デモ） -->
  <section class="card" id="secDraw" style="display:none">
    <div class="ttl" style="font-size:16px">抽選</div>
    <p>抽選を受け付けました。結果はメッセージでご案内します。</p>
    <div class="actions"><button class="btn primary" onclick="location.href='index.html'">ホームへ戻る</button></div>
  </section>

</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a class="active" href="apply.html"><span class="tabicon"></span>申込み</a>
  <a href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  const $ = s => document.querySelector(s);
  const get = k => JSON.parse(localStorage.getItem(k) || "null");
  const put = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const uidKey = 'app.uid';

  function step(n){ [1,2,3,4].forEach(i=>$('#s'+i).classList.toggle('on', i<=n)); }
  function show(id){ ['secInput','secAgree','secPay','secDraw'].forEach(x=>$('#'+x).style.display = (x===id?'block':'none')); }

  function isSubActive(sub){
    if(!sub || !sub.active) return false;
    if(!sub.nextRenewal) return false;
    const today = new Date().toISOString().slice(0,10);
    return sub.nextRenewal >= today;
  }
  function enforceSubValidity(){
    const sub = get('sub');
    if(!sub) return;
    if(!isSubActive(sub)){
      put('sub', {active:false, plan: sub?.plan||'basic', nextRenewal: sub?.nextRenewal||null});
    }
  }

  function calcPay(){
    const credit = Number(localStorage.getItem('credit')||'0');
    const kyc = get('kyc') || {};
    enforceSubValidity();
    const sub = get('sub') || {active:false};

    let now = 0;
    const mode = document.querySelector('input[name="pay"]:checked')?.value || 'one';

    if(kyc.gender==='female'){ now = 0; }
    else if(isSubActive(sub)){ now = 0; }
    else if(mode==='sub'){ now = 1980; }
    else { now = 1000; }

    $('#bal').textContent = credit;
    $('#payNow').textContent = now;
    $('#balAfter').textContent = credit - now;

    const lack = (credit - now) < 0;
    $('#lack').style.display = lack ? 'inline-flex' : 'none';
    $('#goCharge').style.display = lack ? 'inline-flex' : 'none';
    $('#confirmPay').disabled = lack;
  }

  $('#chkAgree')?.addEventListener('change', ()=>{ $('#toPay').disabled = !$('#chkAgree').checked; });
  document.addEventListener('change', (e)=>{ if(e.target.name==='pay'){ calcPay(); } });

  $('#toAgree')?.addEventListener('click', ()=>{
    const kyc = get('kyc') || {};
    const p = get('profile') || {};
    if(!kyc.verified){ alert('本人確認が未完了です。マイページで本人確認を行ってください。'); location.href='mypage.html'; return; }
    if(!p.name || !p.age || !p.area){ alert('プロフィールの必須項目（ニックネーム・年齢・エリア）が未入力です。'); location.href='mypage.html'; return; }

    const draft = {
      pairs: $('#inPairs').value, area: $('#inArea').value, ageBand: $('#inAgeBand').value,
      selfScore: Number($('#inSelf').value||0), friends:($('#inFriends').value||'').trim()
    };
    put('apply.draft', draft);

    step(2); show('secAgree');
  });
  $('#backToInput').addEventListener('click', ()=>{ step(1); show('secInput'); });
  $('#toPay').addEventListener('click', ()=>{ step(3); show('secPay'); updatePayUI(); });
  $('#backToAgree').addEventListener('click', ()=>{ step(2); show('secAgree'); });

  function updatePayUI(){
    enforceSubValidity();
    const kyc = get('kyc') || {};
    const sub = get('sub') || {active:false};

    $('#femaleFree').style.display = (kyc.gender==='female') ? 'inline-flex' : 'none';
    $('#payOptions').style.display = (kyc.gender==='female' || isSubActive(sub)) ? 'none' : 'grid';

    calcPay();
  }

  $('#confirmPay').addEventListener('click', async ()=>{
    const credit = Number(localStorage.getItem('credit')||'0');
    const kyc = get('kyc') || {};
    enforceSubValidity();
    const sub = get('sub') || {active:false, plan:'basic'};
    const mode = document.querySelector('input[name="pay"]:checked')?.value || 'one';

    let pay = 0;
    if(kyc.gender==='female'){ pay = 0; }
    else if(isSubActive(sub)){ pay = 0; }
    else if(mode==='sub'){ pay = 1980; sub.active = true; sub.plan='basic'; sub.nextRenewal = new Date(Date.now()+30*24*60*60*1000).toISOString().slice(0,10); }
    else{ pay = 1000; }

    if(credit - pay < 0){ alert('残高が不足しています。ホームでチャージしてください。'); return; }

    localStorage.setItem('credit', String(credit - pay));
    if(sub.active) put('sub', sub);

    // 通知
    addNoti({ type: sub.active && pay===1980 ? 'sub_join' : 'pay',
      text: sub.active && pay===1980 ? `サブスクに加入しました（ベーシック）。次回更新日：${sub.nextRenewal||''}` :
            `申込みの支払いが完了しました（${pay} pt）` });

    // ログ
    try{
      const line = await liff.getProfile().catch(()=>({displayName:'', userId:''}));
      const uid = localStorage.getItem(uidKey)||'';
      const draft = get('apply.draft')||{};
      await SYNC.logEvent('apply_submitted', {
        uid, pairs:draft.pairs, area:draft.area, ageBand:draft.ageBand,
        selfScore:draft.selfScore, friends:draft.friends, pay, gender: kyc.gender||''
      });
    }catch(e){ console.warn(e); }

    step(4); show('secDraw');
  });

  function addNoti(n){
    const key='noti.items';
    const arr = JSON.parse(localStorage.getItem(key)||'[]');
    arr.push({date:new Date().toISOString().replace('T',' ').slice(0,19), ...n});
    localStorage.setItem(key, JSON.stringify(arr));
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    step(1); show('secInput');

    try{
      await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login({redirectUri: location.href}); return; }
      const prof = await liff.getProfile();
      ensureAppUID(prof.userId);
      await SYNC.syncOnLogin(prof);
    }catch(e){
      console.warn(e);
      ensureAppUID('LOCAL-'+Date.now());
    }

    updatePayUI();
  });
</script>
</body>
</html>
