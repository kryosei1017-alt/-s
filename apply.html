<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>LIFF Minimal｜申込み</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --radius:16px; --fs:13px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
    line-height:1.6;overflow-x:hidden;font-size:var(--fs);
    writing-mode:horizontal-tb!important;-webkit-writing-mode:horizontal-tb!important;text-orientation:mixed!important;
    touch-action:manipulation;
  }
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px 112px}
  header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px}
  .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ttl{font-weight:800;font-size:18px}
  .sub{color:var(--muted);font-size:var(--fs)}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:14px 16px;border-radius:14px;font-size:var(--fs);cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  label{display:block;margin:8px 0 4px;font-weight:700}
  input,select,textarea{width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px;font-size:var(--fs)}
  textarea{min-height:96px}
  .stepper{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:6px 0 10px}
  .seg{height:10px;border-radius:999px;background:#E0E7E0}.seg.on{background:var(--accent)}
  .row{display:flex;gap:10px;align-items:center}
  .radioList{border:1px dashed var(--border);border-radius:12px;padding:8px}
  .radioItem{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px}
  .radioItem + .radioItem{border-top:1px dashed var(--border)}
  .right{margin-left:auto}
  .tabbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center;font-size:var(--fs)}
  .tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
  .hint{font-size:var(--fs);color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="ttl">申込み</div>
    <div class="sub">入力 → 同意 → 決済 → 抽選</div>
  </div>
</header>

<main class="wrap">
  <!-- 進捗 -->
  <div class="stepper" aria-hidden="true">
    <div class="seg" id="s1"></div><div class="seg" id="s2"></div><div class="seg" id="s3"></div><div class="seg" id="s4"></div>
  </div>

  <!-- 入力 -->
  <section class="card" id="secInput">
    <div class="ttl" style="font-size:16px">入力</div>
    <label>人数</label>
    <select id="inGroup">
      <option value="2">2対2</option>
      <option value="3">3対3</option>
    </select>

    <label>エリア</label>
    <select id="inArea">
      <option value="">選択してください</option>
      <option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option>
      <option>名古屋</option><option>大阪</option><option>福岡</option>
    </select>

    <label>希望年齢層</label>
    <select id="inAgePref">
      <option>20-24</option><option>25-29</option><option>30-34</option>
      <option>35-39</option><option>40-44</option><option>45+</option>
    </select>

    <label>自己評価スコア（0〜100）</label>
    <input id="inSelf" type="number" min="0" max="100" value="50"/>

    <label>友だちの個別ID（カンマ区切り）</label>
    <input id="inFriends" placeholder="例）GX-ABC1234,GX-XYZ9KLM"/>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="btn" onclick="location.href='index.html'">戻る</button>
      <button class="btn primary" id="toAgree">同意へ進む</button>
    </div>
    <p class="hint">※ 本人確認が未完了／プロフィール必須項目未入力だと先へ進めません。</p>
  </section>

  <!-- 同意 -->
  <section class="card" id="secAgree" style="display:none">
    <div class="ttl" style="font-size:16px">同意</div>
    <div class="hint" style="border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;background:#FFF9E6">
      <b>本人確認について：</b>必要に応じて身分証とセルフィーの提出をお願いする場合があります。年齢・なりすまし対策のためです。
    </div>

    <a class="btn" href="terms.html" target="_blank" rel="noopener">利用規約を開く</a>

    <div class="row" style="margin-top:10px;gap:10px">
      <label class="row" style="gap:10px;border:1px solid var(--border);border-radius:12px;padding:12px;flex:1;background:#fff">
        <input id="chkAgree" type="checkbox" />
        <span>利用規約に同意する</span>
      </label>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="btn" id="backToInput">戻る</button>
      <button class="btn primary" id="toPay" disabled>決済へ進む</button>
    </div>
  </section>

  <!-- 決済 -->
  <section class="card" id="secPay" style="display:none">
    <div class="ttl" style="font-size:16px">決済</div>
    <div class="sub">クレジット残高から差し引きます。</div>

    <div class="radioList" style="margin-top:8px">
      <div class="radioItem">
        <input type="radio" name="payPlan" id="payOnce" value="once" checked />
        <label for="payOnce" class="row" style="gap:10px;flex:1">
          <span>単発で支払う</span>
          <span class="right sub">（− <span id="onceCost">1000</span> pt）</span>
        </label>
      </div>
      <div class="radioItem">
        <input type="radio" name="payPlan" id="paySub" value="sub" />
        <label for="paySub" class="row" style="gap:10px;flex:1">
          <span>サブスクに加入して支払う</span>
          <span class="right sub">（初回 −1980 pt／次回以降 0 pt）</span>
        </label>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between"><b>現在の残高</b><b><span id="curCr">0</span> pt</b></div>
      <div class="row" style="justify-content:space-between"><b>今回の支払い</b><b>− <span id="thisPay">1000</span> pt</b></div>
      <hr style="border:none;border-top:1px dashed var(--border);margin:10px 0" />
      <div class="row" style="justify-content:space-between"><b>決済後の残高</b><b><span id="aftCr">0</span> pt</b></div>
      <p id="needCharge" class="hint" style="margin-top:8px;display:none">残高が不足しています。<a href="index.html">ホーム</a>でチャージしてください。</p>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="btn" id="backToAgree">戻る</button>
      <button class="btn" id="toCharge" onclick="location.href='index.html'">ホームでチャージ</button>
      <button class="btn primary" id="payConfirm">この内容で確定</button>
    </div>
  </section>

  <!-- 抽選 -->
  <section class="card" id="secDraw" style="display:none">
    <div class="ttl" style="font-size:16px">抽選</div>
    <p>申込みを受け付けました。結果はLINEでお知らせします。</p>
  </section>
</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a class="active" href="apply.html"><span class="tabicon"></span>申込み</a>
  <a href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  // ピンチズーム無効
  window.addEventListener('gesturestart', e => e.preventDefault());

  const FEMALE_FREE = true;        // 女性は支払い0
  const ONCE_COST   = 1000;        // 単発コスト
  const SUB_FIRST   = 1980;        // サブスク初回
  const SUB_PLAN    = "basic";

  const $=s=>document.querySelector(s);
  const credit   = ()=> Number(localStorage.getItem('credit') || '0');
  const setCredit=v=>localStorage.setItem('credit', String(v));
  const getKyc   =()=> JSON.parse(localStorage.getItem('kyc') || '{}');
  const getProf  =()=> JSON.parse(localStorage.getItem('profile') || '{}');
  const getSub   =()=> JSON.parse(localStorage.getItem('sub') || '{}');
  const setSub   =v => localStorage.setItem('sub', JSON.stringify(v));

  /* 進捗バー */
  function step(i){ [1,2,3,4].forEach(n=>$("#s"+n).classList.toggle('on', n<=i)); }

  /* 入力→同意 */
  $("#toAgree").addEventListener('click', ()=>{
    const prof=getProf(), kyc=getKyc();
    if(!(prof && prof.name && prof.area && prof.age)){ alert("マイページの必須（ニックネーム・年齢・エリア）を入力してください。"); return; }
    if(!(kyc && kyc.verified)){ alert("本人確認が未完了です。マイページで完了させてください。"); return; }

    $("#secInput").style.display="none";
    $("#secAgree").style.display="";
    step(2);
  });
  $("#backToInput").onclick=()=>{ $("#secAgree").style.display="none"; $("#secInput").style.display=""; step(1); };

  /* 同意→決済 */
  $("#chkAgree").addEventListener('change', ()=> $("#toPay").disabled = !$("#chkAgree").checked );
  $("#toPay").addEventListener('click', ()=>{
    $("#secAgree").style.display="none";
    $("#secPay").style.display="";
    refreshPay();
    step(3);
  });
  $("#backToAgree").onclick=()=>{ $("#secPay").style.display="none"; $("#secAgree").style.display=""; step(2); };

  /* 決済計算 */
  function isFemale(){ const kyc=getKyc(); return kyc && kyc.gender === 'female'; }
  function refreshPay(){
    const cur=credit(), sub=getSub();
    const plan = document.querySelector('input[name="payPlan"]:checked').value;

    let pay = 0;
    if(isFemale() && ${FEMALE_FREE}){  // 女性は常に0
      pay = 0;
      $("#paySub").checked = false; $("#payOnce").checked = true;
      document.getElementById('paySub').disabled = true;
    }else{
      document.getElementById('paySub').disabled = false;
      if(plan==='once') pay = ONCE_COST;
      else{
        // すでにサブスク中なら0、未加入なら初回1980
        pay = sub && sub.active ? 0 : SUB_FIRST;
      }
    }

    $("#curCr").textContent = cur;
    $("#thisPay").textContent= pay;
    $("#onceCost").textContent= ONCE_COST;
    $("#aftCr").textContent = cur - pay;
    $("#needCharge").style.display = (cur - pay) < 0 ? "block" : "none";
  }
  document.querySelectorAll('input[name="payPlan"]').forEach(r=> r.addEventListener('change', refreshPay));

  /* 決済確定 */
  $("#payConfirm").addEventListener('click', ()=>{
    const cur=credit();
    const plan = document.querySelector('input[name="payPlan"]:checked').value;
    const sub = getSub();

    let pay=0, nextCredit=cur;

    if(isFemale() && ${FEMALE_FREE}){
      pay=0;
    }else{
      if(plan==='once'){ pay=ONCE_COST; }
      else{
        if(sub && sub.active){ pay=0; }
        else{
          pay=SUB_FIRST;
          const next = new Date(Date.now()+30*864e5);
          setSub({active:true, plan:SUB_PLAN, since:new Date().toISOString(), nextRenewal:next.toISOString()});
        }
      }
    }

    if(cur - pay < 0){ alert("残高が不足しています。ホームでチャージしてください。"); return; }

    nextCredit = cur - pay;
    setCredit(nextCredit);
    localStorage.setItem("state.step","3");

    // 履歴＋同期
    const APPLY = { plan, payAmount: pay };
    SYNC.logEvent('payment', { plan: APPLY.plan, pay: APPLY.payAmount });
    SYNC.syncNow();

    $("#secPay").style.display="none";
    $("#secDraw").style.display="";
    step(4);
  });

  // 初期化
  document.addEventListener('DOMContentLoaded', ()=>{
    step(1);
  });
</script>
</body>
</html>
