<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>LIFF Minimal｜申込み</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
:root{ --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59; --border:#E5E7EB; --radius:16px; --fs:13px; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;line-height:1.6;overflow-x:hidden;font-size:var(--fs);touch-action:manipulation;
  writing-mode: horizontal-tb !important; -webkit-writing-mode: horizontal-tb !important; text-orientation: mixed !important;}
.wrap{max-width:720px;margin:0 auto;padding:12px 16px 112px}
header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px}
.hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ttl{font-weight:800;font-size:18px}
.sub{color:var(--muted)}
.card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:12px 14px;border-radius:14px;font-size:14px;cursor:pointer}
.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.row{display:flex;gap:10px;align-items:center}
.stepper{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:10px 0}
.seg{height:10px;border-radius:999px;background:#E0E7E0}.seg.on{background:var(--accent)}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
.tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center}
.tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
.tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
.label{display:block;margin-top:8px;font-weight:700}
input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
.paybox{border:1px dashed var(--border);border-radius:12px;padding:12px}
.hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header><div class="hrow"><div class="ttl">申込み</div><div class="sub">入力 → 同意 → 決済 → 抽選</div></div></header>
<main class="wrap">

  <!-- 入力 -->
  <section class="card" id="secInput">
    <div class="stepper"><div class="seg on"></div><div class="seg"></div><div class="seg"></div><div class="seg"></div></div>
    <div class="ttl" style="font-size:17px">入力</div>

    <label class="label">人数</label>
    <select id="inPair">
      <option value="2x2">2対2</option>
      <option value="3x3">3対3</option>
    </select>

    <label class="label">エリア</label>
    <select id="inArea">
      <option value="" selected>選択してください</option>
      <option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option>
      <option>名古屋</option><option>大阪</option><option>福岡</option>
    </select>

    <label class="label">希望年齢層</label>
    <select id="inAge"><option>20-24</option><option>25-29</option><option>30-34</option></select>

    <label class="label">自己評価スコア（0〜100）</label>
    <input id="inSelf" type="number" min="0" max="100" value="50" />

    <label class="label">友だちの個別ID（カンマ区切り）</label>
    <input id="inFriends" placeholder="例）GX-ABC1234,GX-XYZ9KLM" />

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="btn" onclick="location.href='index.html'">戻る</button>
      <button class="btn primary" id="toAgree">同意へ進む</button>
    </div>
    <p class="hint">※ 本人確認未完了／プロフィール必須項目未入力だと先へ進めません。</p>
  </section>

  <!-- 同意 -->
  <section class="card" id="secAgree" style="display:none">
    <div class="stepper"><div class="seg on"></div><div class="seg on"></div><div class="seg"></div><div class="seg"></div></div>
    <div class="ttl" style="font-size:17px">同意</div>

    <div class="hint" style="border:1px solid var(--border);border-radius:12px;padding:12px;background:#FFF9E6">
      <b>本人確認について：</b>必要に応じて身分証とセルフィーの提出をお願いする場合があります。年齢・なりすまし対策のためです。
    </div>

    <a class="btn" href="terms.html" target="_blank" rel="noopener">利用規約を開く</a>

    <div class="row" style="margin-top:10px;gap:10px;align-items:center">
      <label class="row" style="gap:10px;flex:1;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff">
        <input id="chkAgree" type="checkbox" style="width:22px;height:22px" />
        <span>利用規約に同意する</span>
      </label>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="btn" id="backToInput">戻る</button>
      <button class="btn primary" id="toPay" disabled>決済へ進む</button>
    </div>
  </section>

  <!-- 決済 -->
  <section class="card" id="secPay" style="display:none">
    <div class="stepper"><div class="seg on"></div><div class="seg on"></div><div class="seg on"></div><div class="seg"></div></div>
    <div class="ttl" style="font-size:17px">決済</div>

    <div class="paybox">
      <div class="hint">お支払い方法</div>
      <label class="row" style="gap:10px;align-items:center;margin:6px 0">
        <input type="radio" name="pay" value="once" checked />
        <span>単発で支払う（<span id="oncePt">-1000</span> pt）</span>
      </label>
      <label class="row" style="gap:10px;align-items:center;margin:6px 0">
        <input type="radio" name="pay" value="sub" />
        <span>サブスクに加入して支払う（初回 <b>-1980</b> pt、次回以降 0 pt）</span>
      </label>
    </div>

    <div class="card" style="margin:12px 0;background:#FAFAF7">
      <div class="row" style="justify-content:space-between"><div>現在の残高</div><div><span id="nowPt">0</span> pt</div></div>
      <div class="row" style="justify-content:space-between"><div>今回の支払い</div><div><span id="payPt">-1000</span> pt</div></div>
      <hr style="border:none;border-top:1px dashed var(--border);margin:10px 0" />
      <div class="row" style="justify-content:space-between;font-weight:700"><div>決済後の残高</div><div><span id="afterPt">0</span> pt</div></div>
      <div class="hint" id="needCharge" style="color:#b91c1c;display:none;margin-top:6px">残高が不足しています。ホームでチャージしてください。</div>
    </div>

    <div class="row" style="justify-content:space-between">
      <button class="btn" id="backToAgree">戻る</button>
      <button class="btn" id="goCharge" style="white-space:nowrap">ホームでチャージ</button>
      <button class="btn primary" id="toConfirm">この内容で確定</button>
    </div>
  </section>

  <!-- 抽選（ダミー） -->
  <section class="card" id="secLottery" style="display:none">
    <div class="stepper"><div class="seg on"></div><div class="seg on"></div><div class="seg on"></div><div class="seg on"></div></div>
    <div class="ttl" style="font-size:17px">抽選</div>
    <p>申込みを受け付けました。結果は通知します。</p>
    <div class="row" style="justify-content:flex-end"><button class="btn primary" onclick="location.href='index.html'">ホームへ</button></div>
  </section>

</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a class="active" href="apply.html"><span class="tabicon"></span>申込み</a>
  <a href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
const APP={ LIFF_ID:"2008178197-ELrxabO9" };
const $=s=>document.querySelector(s);
const getPayMode=()=>document.querySelector('input[name="pay"]:checked').value;

function ensureUID(){
  let uid = localStorage.getItem('appUID');
  if(!uid){ uid='GX-'+Math.random().toString(36).slice(2,6).toUpperCase()+'-'+Date.now().toString().slice(-6); localStorage.setItem('appUID',uid); }
}

function checkPrereq(){
  const kyc = JSON.parse(localStorage.getItem('kyc')||'{}');
  const prof = JSON.parse(localStorage.getItem('profile')||'{}');
  if(!kyc.verified) return {ok:false, reason:'kyc'};
  if(!prof || !prof.name || !prof.age || !prof.area) return {ok:false, reason:'profile'};
  return {ok:true};
}

function calc(){
  const credit = Number(localStorage.getItem('credit')||'0');
  const kyc = JSON.parse(localStorage.getItem('kyc')||'{}');
  const isFemale = kyc.gender==='female';
  let pay = 0;
  if(isFemale){
    pay = 0;
  }else{
    pay = (getPayMode()==='sub') ? 1980 : 1000;
  }
  const after = credit - pay;
  $("#nowPt").textContent = credit;
  $("#payPt").textContent = `-${pay}`;
  $("#afterPt").textContent = Math.max(0, after);
  const need = after < 0; $("#needCharge").style.display = need?'block':'none';
  return {pay, need};
}

document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
    ensureUID();
    const pf = await liff.getProfile();
    await SYNC.syncOnLogin(pf);
  }catch(e){ console.warn(e); }

  $("#toAgree").addEventListener('click', ()=>{
    const can = checkPrereq();
    if(!can.ok){
      alert(can.reason==='kyc'?'本人確認を完了してください（マイページ）':'プロフィールの必須項目（ニックネーム・年齢・エリア）を入力してください（マイページ）');
      return;
    }
    $("#secInput").style.display='none'; $("#secAgree").style.display='block';
  });
  $("#backToInput").addEventListener('click', ()=>{ $("#secAgree").style.display='none'; $("#secInput").style.display='block'; });
  $("#chkAgree").addEventListener('change', e=> $("#toPay").disabled = !e.target.checked );

  $("#toPay").addEventListener('click', ()=>{
    $("#secAgree").style.display='none'; $("#secPay").style.display='block';
    calc();
  });
  $("#backToAgree").addEventListener('click', ()=>{ $("#secPay").style.display='none'; $("#secAgree").style.display='block'; });

  document.querySelectorAll('input[name="pay"]').forEach(r=> r.addEventListener('change', calc) );
  $("#goCharge").addEventListener('click', ()=> location.href='index.html' );

  $("#toConfirm").addEventListener('click', async ()=>{
    const {pay,need}=calc(); if(need){ alert('残高が不足しています'); return; }
    const credit=Number(localStorage.getItem('credit')||'0'); const next=credit-pay; localStorage.setItem('credit', String(next));
    if(getPayMode()==='sub'){
      const sub={active:true, plan:'basic', nextRenewal:new Date(Date.now()+1000*60*60*24*30).toISOString().slice(0,10)};
      localStorage.setItem('sub', JSON.stringify(sub));
    }
    await SYNC.syncNow();
    $("#secPay").style.display='none'; $("#secLottery").style.display='block';
  });
});
</script>
</body>
</html>
