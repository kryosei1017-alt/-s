<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<!-- ★ズーム無効化（全ページ統一） -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>LIFF Minimal｜申込み</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59; --border:#E5E7EB; --radius:16px;
    --tabbarH:96px; --headerH:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
    line-height:1.6;overflow-x:hidden;
    /* 縦書き化対策 */
    writing-mode:horizontal-tb!important; -webkit-writing-mode:horizontal-tb!important; text-orientation:mixed!important;
  }
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px calc(var(--tabbarH) + 16px);
        min-height:calc(100dvh - var(--headerH) - var(--tabbarH)); display:flex; flex-direction:column;}
  header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px;min-height:var(--headerH);display:flex;align-items:center}
  .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ttl{font-weight:800;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:14px 16px;border-radius:14px;font-size:16px;cursor:pointer;writing-mode:horizontal-tb!important}
  .btn--sm{min-width:92px}
  .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px;writing-mode:horizontal-tb!important}
  label{display:block;font-size:14px;margin:10px 0 6px}
  input, textarea, select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
  textarea{min-height:88px;resize:vertical}
  .stepper{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:6px 0 10px}
  .seg{height:10px;border-radius:999px;background:#E0E7E0}.seg.on{background:var(--accent)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .info{background:#fffbeb;border:1px solid #fcd34d;color:#593d00;padding:12px;border-radius:12px;font-size:13px}
  .warn{background:#FEF2F2;border:1px solid #FCA5A5;color:#7F1D1D}
  .em{font-weight:800}
  .muted{color:#6B7280}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff}
  .badge.ok{border-color:#86efac;background:#ecfdf5;color:#065f46}
  .badge.ng{border-color:#fecaca;background:#fff1f2;color:#7f1d1d}

  .tabbar{position:fixed;left:0;right:0;bottom:0;height:var(--tabbarH);background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center;writing-mode:horizontal-tb!important}
  .tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}

  /* 決済ステップを全面横書き固定 */
  #stepPayment, #stepPayment *{ writing-mode:horizontal-tb!important; -webkit-writing-mode:horizontal-tb!important; text-orientation:mixed!important; }
  .payCard{border:1px dashed var(--border);border-radius:14px;padding:14px;overflow:hidden}
  .payopt{width:100%;display:grid;grid-template-columns:auto 1fr;align-items:center;gap:10px;margin:0 0 10px 0}
  .payopt:last-child{margin-bottom:0}
  .payopt input[type="radio"]{width:22px;height:22px}
  .labeltext{display:block;white-space:normal!important;overflow-wrap:anywhere;line-height:1.5}

  .btnRow{display:flex;gap:8px;margin-top:12px;justify-content:space-between;align-items:center}

  /* 同意チェック：白枠で横並び */
  .consentBox{
    display:flex; align-items:center; gap:12px;
    border:1px solid var(--border); border-radius:12px;
    padding:12px 14px; background:#fff; margin-top:8px; max-width:100%;
    writing-mode:horizontal-tb!important; -webkit-writing-mode:horizontal-tb!important; text-orientation:mixed!important;
  }
  .consentBox input[type="checkbox"]{ width:22px; height:22px; flex:0 0 auto; }
  .consentText{ flex:1 1 auto; text-align:left; white-space:normal; overflow-wrap:anywhere; }

  /* 「ホームでチャージ」も横書き固定 */
  #payGoCharge, #payGoCharge *{ writing-mode:horizontal-tb!important; -webkit-writing-mode:horizontal-tb!important; text-orientation:mixed!important; }
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="ttl">申込み</div>
    <div class="sub">入力 → 同意 → 決済 → 抽選</div>
  </div>
</header>

<main class="wrap">
  <!-- 入力 -->
  <div class="card" id="stepInfo">
    <div class="hrow" style="justify-content:space-between">
      <div class="ttl" style="font-size:16px">申込み情報</div>
      <button class="btn" onclick="location.href='index.html'">ホームに戻る</button>
    </div>
    <div class="stepper"><div class="seg" id="seg1"></div><div class="seg" id="seg2"></div><div class="seg" id="seg3"></div></div>

    <!-- KYC 状態（マイページと連動） -->
    <div class="hrow" style="justify-content:space-between;align-items:center;margin:8px 0">
      <div class="badge" id="kycBadge">KYC確認状況: 取得中...</div>
      <button class="btn btn--sm" id="kycDemoBtn">本人確認（デモ）</button>
    </div>
    <div class="info warn" id="kycWarn" style="display:none">
      <b>本人確認が未完了です。</b> 申込み前に本人確認を済ませてください（デモでは「本人確認（デモ）」から設定できます）。
    </div>

    <label>パーティ構成（人数）</label>
    <div class="chips" id="chipsSize">
      <span class="chip" data-v="2v2">2 : 2</span>
      <span class="chip" data-v="3v3">3 : 3</span>
    </div>

    <!-- 申込者グループの性別 フィールドは削除（KYC性別を使用） -->

    <label>希望相手グループの性別</label>
    <div class="chips" id="chipsGender">
      <span class="chip" data-v="male">男性グループ</span>
      <span class="chip" data-v="female">女性グループ</span>
    </div>

    <label>エリア</label>
    <select id="inArea">
      <option value="">選択してください</option>
      <option value="tokyo">東京</option>
      <option value="yokohama">横浜</option>
      <option value="chiba">千葉</option>
      <option value="saitama">埼玉</option>
      <option value="nagoya">名古屋</option>
      <option value="osaka">大阪</option>
      <option value="fukuoka">福岡</option>
    </select>

    <label>相手の希望年齢層</label>
    <div class="hrow" style="gap:10px">
      <select id="ageMin" style="flex:1"><option value="">下限</option></select>
      <span class="sub">〜</span>
      <select id="ageMax" style="flex:1"><option value="">上限</option></select>
    </div>

    <label>自己評価スコア（0〜100）</label>
    <div class="hrow" style="gap:10px;align-items:center">
      <input id="inScore" type="range" min="0" max="100" step="1" value="50" oninput="document.getElementById('scoreVal').textContent=this.value">
      <span id="scoreVal" class="chip" style="border-style:dashed">50</span>
    </div>

    <label>友だちのLINE ID（改行で複数）<textarea id="inFriends" placeholder="例：friend_aaa
friend_bbb"></textarea></label>

    <div class="hrow" style="gap:8px;margin-top:6px">
      <button class="btn primary" id="btnCreateApply">申込み内容を確定</button>
    </div>

    <!-- ▼ デモ用：本人確認の簡易設定（マイページと連動） -->
    <div id="kycDemoPanel" class="card" style="margin-top:10px; display:none">
      <div class="ttl" style="font-size:15px">本人確認（デモ）</div>
      <p class="sub">外部eKYCが未決定のため、検証用にローカルで状態を切り替えます。</p>
      <div class="chips" id="chipsKyc">
        <span class="chip" data-v="none">未完了</span>
        <span class="chip" data-v="male">男性で確認済み</span>
        <span class="chip" data-v="female">女性で確認済み</span>
      </div>
      <div class="info" style="margin-top:8px">
        ・設定は端末のローカルに保存されます（本番APIとは連動しません）。<br>
        ・性別は決済ロジックに反映されます（<b>女性は無料</b>）。<br>
        ・未完了のままでは申込みできません。
      </div>
      <p class="sub">※ 同じアカウントで開いた <b>マイページ</b> でも同じ状態になります。</p>
    </div>
    <!-- ▲ デモ用 -->
  </div>

  <!-- 同意 -->
  <div class="card" id="stepConsent" style="display:none">
    <div class="ttl" style="font-size:16px">同意</div>
    <p class="sub">以下の利用規約を確認のうえ、同意してください。</p>
    <div class="info" style="margin:8px 0">
      <b>本人確認について</b>：必要に応じて身分証とセルフィーの提出をお願いする場合があります。年齢・なりすまし対策のためです。
    </div>
    <p><a class="btn" href="terms.html" target="_blank" rel="noopener">利用規約を開く</a></p>

    <label class="consentBox" id="consentWrap">
      <input id="agreeChk" type="checkbox" />
      <span class="consentText">利用規約に同意する</span>
    </label>

    <div class="btnRow">
      <button class="btn btn--sm" id="consentBack">戻る</button>
      <button class="btn primary" id="consentNext" disabled>決済へ進む</button>
    </div>
  </div>

  <!-- 決済 -->
  <div class="card" id="stepPayment" style="display:none">
    <div class="ttl" style="font-size:16px">決済</div>
    <p class="sub">クレジット残高から差し引きます。</p>

    <div id="femaleFreeWrap" style="display:none">
      <div class="info"><b>女性は無料</b>：今回の支払いは <span class="em">0 pt</span> です。</div>
    </div>
    <div id="subActiveWrap" style="display:none">
      <div class="info"><b>サブスク加入中</b>：今回の支払いは <span class="em">0 pt</span> です。</div>
    </div>

    <div id="planChoiceWrap" style="display:none">
      <label style="margin-top:6px">お支払い方法</label>
      <div class="payCard">
        <label class="payopt">
          <input type="radio" name="payplan" value="oneoff" checked />
          <span class="labeltext">単発で支払う <span class="muted mono" id="priceOneoff"></span></span>
        </label>
        <label class="payopt">
          <input type="radio" name="payplan" value="sub" />
          <span class="labeltext">サブスクに加入して支払う <span class="muted mono" id="priceSub"></span><span class="sub">（次回以降 0 pt）</span></span>
        </label>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="hrow" style="justify-content:space-between">
        <div>現在の残高</div><div class="mono"><span id="creditBefore">—</span> pt</div>
      </div>
      <div class="hrow" style="justify-content:space-between">
        <div>今回の支払い</div><div class="mono">- <span id="payAmount">—</span> pt</div>
      </div>
      <hr style="border:none;border-top:1px dashed var(--border);margin:10px 0">
      <div class="hrow" style="justify-content:space-between;font-weight:800">
        <div>決済後の残高</div><div class="mono"><span id="creditAfter">—</span> pt</div>
      </div>
      <div id="payError" class="sub" style="color:#991B1B;display:none;margin-top:6px">残高が不足しています。ホームでチャージしてください。</div>
    </div>

    <div class="btnRow">
      <button class="btn btn--sm" id="payBack">戻る</button>
      <button class="btn" id="payGoCharge"><span class="labeltext">ホームで<wbr>チャージ</span></button>
      <button class="btn primary" id="payConfirm">この内容で確定</button>
    </div>
  </div>

  <!-- 抽選 -->
  <div class="card" id="stepLottery" style="display:none">
    <div class="ttl" style="font-size:16px">抽選</div>
    <p class="sub">決済確認後に抽選を行います。</p>
    <div class="btnRow">
      <button class="btn btn--sm" id="lotBack">戻る</button>
      <button class="btn primary" id="lotStart">抽選を開始</button>
    </div>
    <div id="lotResult" style="margin-top:10px;font-weight:800"></div>
  </div>
</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a class="active" href="apply.html"><span class="tabicon"></span>申込み</a>
  <a href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  const PRICING = { ONE_OFF: 1000, SUB_JOIN_COST: 1980 };
  const APP   = { LIFF_ID:"2008178197-ELrxabO9",
                  API:"https://script.google.com/macros/s/AKfycbzvAK9-fg02CJAmAO73XyuaN3HjF0k0bDncAxtWdn2MVOhTub1T9hT8bSs9XG0_4qxC/exec" };
  const AUTH  = { userId:"", idToken:"" };
  const APPLY = { draft:null, paid:false, selectedPlan:null, payAmount:0 };

  const $=s=>document.querySelector(s);
  const show = id => ["stepInfo","stepConsent","stepPayment","stepLottery"].forEach(k=>document.getElementById(k).style.display = (k===id?"block":"none"));
  const mark = step => { [1,2,3].forEach(i=>document.getElementById("seg"+i).classList.toggle("on", i<=step)); localStorage.setItem("state.step", String(step)); };

  /* ====== 共有：KYC helpers（mypage と連動） ====== */
  const getKyc   = ()=> JSON.parse(localStorage.getItem("kyc")||"{}");
  const setKyc   = k  => { k.updated=new Date().toISOString(); localStorage.setItem("kyc", JSON.stringify(k)); renderKycUI(); };
  const kycVerified = ()=> !!getKyc().verified;
  const kycGender   = ()=> getKyc().gender;

  function renderKycUI(){
    const k = getKyc();
    const badge = $("#kycBadge");
    const warn  = $("#kycWarn");
    if(k.verified){
      const sex = k.gender==='female' ? '女性' : (k.gender==='male' ? '男性' : '不明');
      badge.className = "badge ok";
      badge.textContent = `KYC確認済み：${sex}`;
      warn.style.display = "none";
    }else{
      badge.className = "badge ng";
      badge.textContent = "KYC未完了";
      warn.style.display = "block";
    }
  }

  // KYC デモ UI
  $("#kycDemoBtn").addEventListener("click", ()=>{
    const p = $("#kycDemoPanel");
    p.style.display = (p.style.display==="none"||!p.style.display) ? "block":"none";
  });
  (function setupKycChips(){
    const el = $("#chipsKyc"); if(!el) return;
    el.addEventListener("click",(e)=>{
      const t = e.target.closest('.chip'); if(!t) return;
      [...el.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
      t.classList.add('active');
      const v = t.dataset.v; // none | male | female
      if(v==="male")   setKyc({verified:true, gender:'male'});
      else if(v==="female") setKyc({verified:true, gender:'female'});
      else            setKyc({verified:false});
    });
  })();

  // 年齢選択肢
  (function(){
    const minSel=$("#ageMin"), maxSel=$("#ageMax");
    for(let i=18;i<=49;i++){ const o=document.createElement('option'); o.value=o.textContent=i; minSel.appendChild(o); }
    for(let i=18;i<=59;i++){ const o=document.createElement('option'); o.value=o.textContent=i; maxSel.appendChild(o); }
  })();

  // チップ選択
  function makeChipGroup(id){
    const el = document.getElementById(id), sel = { value:null };
    el.addEventListener('click', (e)=>{
      const t=e.target.closest('.chip'); if(!t) return;
      el.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      t.classList.add('active'); sel.value=t.dataset.v;
    });
    return sel;
  }
  const sizeSel   = makeChipGroup('chipsSize');
  const genderSel = makeChipGroup('chipsGender');

  // LocalStorage helpers（省略形）
  const getCredit = ()=> Number(localStorage.getItem("credit")||"0");
  const setCredit = v => localStorage.setItem("credit", String(v));
  const getSub    = ()=> JSON.parse(localStorage.getItem("sub")||"{}");
  const setSub    = s => localStorage.setItem("sub", JSON.stringify(s));
  const getProfile= ()=> JSON.parse(localStorage.getItem("profile")||"{}");

  // 入力確定 → 同意へ
  $("#btnCreateApply").addEventListener("click", async ()=>{
    if(!kycVerified()){
      alert("本人確認が未完了です。本人確認（デモ）から「確認済み」を選択してください。");
      $("#kycDemoPanel").style.display = "block";
      return;
    }
    const group = sizeSel.value || "2v2";
    const targetGender = genderSel.value; if(!targetGender){ alert("希望相手グループの性別を選択してください。"); return; }
    const area = $("#inArea").value; if(!area){ alert("エリアを選択してください。"); return; }
    const ageMin = Number($("#ageMin").value||0);
    const ageMax = Number($("#ageMax").value||0);
    if(ageMin && ageMax && ageMin>ageMax){ alert("年齢の下限・上限が逆になっています。"); return; }
    const score = Number($("#inScore").value||50);
    const friends = ($("#inFriends").value||"").split(/\n+/).map(s=>s.trim()).filter(Boolean);

    APPLY.draft = { group, kycGender: kycGender(), targetGender, area, ageMin, ageMax, score, friends, ts: Date.now() };
    try{ await fetch(APP.API,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ type:"apply_draft", payload:APPLY.draft, auth:AUTH })}); }catch(e){}
    show("stepConsent"); mark(1);
  });

  // 同意
  $("#agreeChk").addEventListener("change", e => $("#consentNext").disabled = !e.target.checked );
  $("#consentBack").addEventListener("click", ()=>{ show("stepInfo"); mark(0); });
  $("#consentNext").addEventListener("click", async ()=>{
    try{ await fetch(APP.API,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ type:"agree", payload:{draft:APPLY.draft}, auth:AUTH })}); }catch(e){}
    setupPaymentUI(); show("stepPayment"); mark(2);
  });

  // 決済UI
  function setupPaymentUI(){
    if(!kycVerified()){ alert("本人確認が未完了です。"); show("stepInfo"); mark(0); return; }

    const profile   = getProfile();
    const sub       = getSub();
    const subActive = !!sub.active;

    const genderKyc = kycGender() || profile.gender;     // KYC最優先
    const isFemale  = (genderKyc === "female");

    $("#priceOneoff").textContent = `(−${PRICING.ONE_OFF} pt)`;
    $("#priceSub").textContent    = `(−${PRICING.SUB_JOIN_COST} pt)`;

    $("#femaleFreeWrap").style.display = isFemale ? "block" : "none";
    $("#subActiveWrap").style.display  = (!isFemale && subActive) ? "block" : "none";
    $("#planChoiceWrap").style.display = (!isFemale && !subActive) ? "block" : "none";

    if(isFemale){ APPLY.selectedPlan="female_free"; APPLY.payAmount=0; }
    else if(subActive){ APPLY.selectedPlan="sub"; APPLY.payAmount=0; }
    else{
      APPLY.selectedPlan = (document.querySelector('input[name="payplan"]:checked')?.value || "oneoff");
      APPLY.payAmount    = (APPLY.selectedPlan==="sub") ? PRICING.SUB_JOIN_COST : PRICING.ONE_OFF;
    }
    renderPaymentNumbers(getCredit(), APPLY.payAmount);

    document.querySelectorAll('input[name="payplan"]').forEach(r=>{
      r.onclick = ()=>{
        APPLY.selectedPlan = r.value;
        APPLY.payAmount    = (r.value==="sub") ? PRICING.SUB_JOIN_COST : PRICING.ONE_OFF;
        renderPaymentNumbers(getCredit(), APPLY.payAmount);
      };
    });
  }

  function renderPaymentNumbers(creditBefore, pay){
    const after = creditBefore - pay;
    $("#creditBefore").textContent = creditBefore;
    $("#payAmount").textContent    = pay;
    $("#creditAfter").textContent  = after;
    const lack = after < 0;
    $("#payError").style.display   = lack ? "block":"none";
    $("#payConfirm").disabled      = lack;
  }

  $("#payBack").addEventListener("click", ()=>{ show("stepConsent"); mark(1); });
  $("#payGoCharge").addEventListener("click", ()=>{ location.href = "index.html"; });
  $("#payConfirm").addEventListener("click", async ()=>{
    const credit = getCredit();
    const need   = APPLY.payAmount || 0;
    const after  = credit - need;
    if(after < 0){ alert("残高が不足しています。ホームでチャージしてください。"); return; }

    setCredit(after);
    if(APPLY.selectedPlan === "sub"){
      const sub = getSub();
      if(!sub.active){
        const newSub = {active:true, plan:"ベーシック", since:new Date().toISOString()};
        setSub(newSub);
        try{ await fetch(APP.API,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ type:"subscribe", payload:newSub, auth:AUTH })}); }catch(e){}
      }
    }
    APPLY.paid = true;
    try{ await fetch(APP.API,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ type:"payment_done", payload:{ draft: APPLY.draft, plan: APPLY.selectedPlan, amount: need }, auth:AUTH })}); }catch(e){}
    show("stepLottery"); mark(3);
  });

  $("#lotBack").addEventListener("click", ()=>{ show("stepPayment"); mark(2); });
  $("#lotStart").addEventListener("click", async ()=>{
    try{
      const r = await fetch(APP.API,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({ type:"enter_lottery", payload:{ draft: APPLY.draft }, auth: AUTH })}).then(r=>r.json());
      const result = r && r.result ? r.result : (Math.random()<0.5 ? "当選" : "落選");
      $("#lotResult").textContent = "結果：" + result;
      const hist = JSON.parse(localStorage.getItem("history")||"[]");
      hist.unshift({ ts:Date.now(), result, payment: APPLY.payAmount, plan: APPLY.selectedPlan });
      localStorage.setItem("history", JSON.stringify(hist));
    }catch(e){ alert("抽選に失敗しました。"); }
  });

  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser: true });
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
      const prof=await liff.getProfile(); AUTH.userId=prof.userId||"";
    }catch(e){ console.warn(e); }
    if(!localStorage.getItem('kyc')){ setKyc({verified:false}); } else { renderKycUI(); }
    mark(Number(localStorage.getItem("state.step")||"0"));
  });
</script>
</body>
</html>
