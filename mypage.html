<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1, minimum-scale=1" />
<title>LIFF Minimal｜マイページ</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --radius:16px; --fs:14px; --fs-sm:12.5px; --fs-lg:18px;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
    line-height:1.6; font-size:var(--fs); overflow-x:hidden;
    -webkit-text-size-adjust:100%;
  }
  /* 横書き固定＋ピンチ無効 */
  html{ writing-mode:horizontal-tb !important; -webkit-writing-mode:horizontal-tb !important; text-orientation:mixed !important; }
  *{ touch-action:manipulation; }

  .wrap{ max-width:720px; margin:0 auto; padding:12px 16px 112px; }
  header{ position:sticky; top:0; z-index:20; background:var(--bg); padding:10px 16px; }
  .hrow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .ttl{ font-weight:800; font-size:var(--fs-lg); }
  .sub{ color:var(--muted); font-size:var(--fs-sm); }

  .uid{ display:flex; align-items:center; gap:8px; font-size:var(--fs-sm); }
  .uid .copy{ padding:8px 12px; border:1px solid var(--border); border-radius:12px; background:#fff; cursor:pointer; }

  .card{ background:#FFF; border:1px solid var(--border); border-radius:var(--radius);
         padding:16px; box-shadow:0 4px 12px rgba(0,0,0,.04); margin-bottom:12px; }
  .row{ display:flex; align-items:center; gap:10px; }
  .row.spread{ justify-content:space-between; }
  .btn{ appearance:none; border:1px solid var(--border); background:#fff; color:#111827;
        padding:12px 14px; border-radius:12px; cursor:pointer; font-size:var(--fs); }
  .btn.primary{ background:var(--accent); color:#fff; border-color:transparent; }
  .btn.ghost{ background:#fff; }
  .btn.small{ padding:8px 10px; font-size:var(--fs-sm); }

  .field{ padding:10px 0; border-bottom:1px solid var(--border); }
  .field:last-child{ border-bottom:none; }
  .label{ color:var(--muted); font-size:var(--fs-sm); }
  .value{ font-weight:600; }

  .editArea input, .editArea select, .editArea textarea{
    width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:var(--fs);
  }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

  .pill{ display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; border-radius:999px;
         background:#E7EFE7; color:#10381F; font-weight:700; font-size:var(--fs-sm); }
  .pill.ok{ background:#E7F5ED; color:#065F46; }
  .pill.warn{ background:#FEF3C7; color:#92400E; }
  .pill.gray{ background:#F3F4F6; color:#111827; }

  .tabbar{ position:fixed; left:0; right:0; bottom:0; height:96px; background:rgba(255,255,255,.96);
           backdrop-filter:blur(10px); border-top:1px solid var(--border); display:flex; z-index:30;
           padding-bottom:calc(env(safe-area-inset-bottom) + 8px) }
  .tabbar a{ flex:1; text-decoration:none; color:#6B7280; padding:18px 6px; display:flex; flex-direction:column; gap:6px; align-items:center; min-height:76px; text-align:center }
  .tabicon{ width:24px; height:24px; border-radius:6px; background:#CBD5CB }
  .tabbar .active{ color:#0d3a23; font-weight:800 } .tabbar .active .tabicon{ background:var(--accent) }
</style>
</head>
<body>
<header>
  <div class="hrow" style="justify-content:space-between;">
    <div class="ttl">マイページ</div>
    <div class="uid">UID: <span id="uidTxt">—</span>
      <button class="copy btn small" id="uidCopy">コピー</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- プロフィール -->
  <section class="card" id="cardProfile">
    <div class="row spread">
      <div class="ttl" style="font-size:16px">プロフィール</div>
      <button class="btn small" id="btnEdit">編集</button>
    </div>

    <!-- 表示 -->
    <div id="profView">
      <div class="field"><div class="label">ニックネーム</div><div class="value" id="vName">—</div></div>
      <div class="field"><div class="label">年齢</div><div class="value" id="vAge">—</div></div>
      <div class="field"><div class="label">エリア</div><div class="value" id="vArea">—</div></div>
      <div class="field"><div class="label">趣味</div><div class="value" id="vHobby">—</div></div>
      <div class="field"><div class="label">好きなこと</div><div class="value" id="vLike">—</div></div>
      <div class="field"><div class="label">普段何してる</div><div class="value" id="vDaily">—</div></div>
      <div class="field"><div class="label">仕事</div><div class="value" id="vJob">—</div></div>
      <div class="field"><div class="label">学校</div><div class="value" id="vSchool">—</div></div>
      <div class="field"><div class="label">自由記入</div><div class="value" id="vFree">—</div></div>
    </div>

    <!-- 編集 -->
    <div id="profEdit" class="editArea" style="display:none; margin-top:8px;">
      <div class="grid2">
        <div>
          <div class="label">ニックネーム（必須）</div>
          <input id="eName" placeholder="ニックネーム" />
        </div>
        <div>
          <div class="label">年齢（必須）</div>
          <input id="eAge" type="number" min="18" max="80" placeholder="年齢" />
        </div>
      </div>
      <div style="margin-top:8px">
        <div class="label">エリア（必須）</div>
        <select id="eArea">
          <option value="">選択してください</option>
          <option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option>
          <option>名古屋</option><option>大阪</option><option>福岡</option>
        </select>
      </div>

      <div class="grid2" style="margin-top:8px">
        <div><div class="label">趣味</div><input id="eHobby"/></div>
        <div><div class="label">好きなこと</div><input id="eLike"/></div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div><div class="label">普段何してる</div><input id="eDaily"/></div>
        <div><div class="label">仕事</div><input id="eJob"/></div>
      </div>
      <div style="margin-top:8px">
        <div class="label">学校</div><input id="eSchool"/>
      </div>
      <div style="margin-top:8px">
        <div class="label">自由記入</div><textarea id="eFree" rows="3"></textarea>
      </div>

      <div class="row" style="gap:8px; justify-content:flex-end; margin-top:10px;">
        <button class="btn" id="btnEditCancel">キャンセル</button>
        <button class="btn primary" id="btnEditSave">保存</button>
      </div>
    </div>
  </section>

  <!-- サブスク 状態 -->
  <section class="card" id="cardSub">
    <div class="row spread">
      <div class="ttl" style="font-size:16px">サブスク</div>
      <div id="subPill" class="pill gray">未加入</div>
    </div>
    <div class="sub" id="subDesc" style="margin-top:6px;">—</div>
    <div class="row" style="gap:8px; margin-top:10px;">
      <!-- デモ操作（本番は申込みで加入） -->
      <button class="btn" id="btnSubJoin">加入（デモ）</button>
      <button class="btn" id="btnSubCancel">解約（デモ）</button>
    </div>
  </section>

  <!-- 本人確認 -->
  <section class="card" id="cardKyc">
    <div class="ttl" style="font-size:16px">本人確認</div>
    <div class="row" style="gap:8px; margin:8px 0;">
      <div id="kycPill" class="pill warn">未完了</div>
      <div id="kycGenderPill" class="pill gray" style="display:none;">—</div>
    </div>
    <div class="sub">※ デモ：性別を選ぶと完了扱い</div>
    <div class="row" style="gap:8px; margin-top:8px;">
      <button class="btn" id="btnKycFemale">女性として確認</button>
      <button class="btn" id="btnKycMale">男性として確認</button>
      <button class="btn ghost" id="btnKycReset">再撮影（やり直し）</button>
    </div>
  </section>

  <!-- 履歴（招待URL） -->
  <section class="card">
    <div class="ttl" style="font-size:16px">履歴</div>
    <div id="hist">まだ履歴がありません。</div>
  </section>

  <!-- お問い合わせ -->
  <section class="card">
    <div class="ttl" style="font-size:16px">お問い合わせ</div>
    <div class="sub">ご不明点は下記からご連絡ください。</div>
    <div class="row" style="gap:8px; margin-top:8px;">
      <a class="btn" href="mailto:support@example.com">メールで問い合わせ</a>
      <a class="btn" href="#" onclick="liff.openWindow({url:'https://line.me/R/ti/p/@YOUR_OFFICIAL', external:true}); return false;">LINE公式を開く</a>
    </div>
  </section>
</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a class="active" href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  const $ = s => document.querySelector(s);
  const get = k => JSON.parse(localStorage.getItem(k) || "null");
  const put = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const uidKey = 'app.uid';

  function isSubActive(sub){
    if(!sub || !sub.active) return false;
    if(!sub.nextRenewal) return false;
    const today = new Date().toISOString().slice(0,10);
    return sub.nextRenewal >= today;
  }

  function enforceSubValidity(){
    const sub = get('sub');
    if(!sub) return;
    if(!isSubActive(sub)){
      put('sub', {active:false, plan: sub?.plan||'basic', nextRenewal: sub?.nextRenewal||null});
    }
  }

  // --- UI 更新 ---
  function renderUID(){
    const uid = localStorage.getItem(uidKey) || '—';
    $('#uidTxt').textContent = uid;
  }

  function renderProfile(){
    const p = get('profile') || {};
    $('#vName').textContent   = p.name || '—';
    $('#vAge').textContent    = p.age  || '—';
    $('#vArea').textContent   = p.area || '—';
    $('#vHobby').textContent  = p.hobby|| '—';
    $('#vLike').textContent   = p.like || '—';
    $('#vDaily').textContent  = p.daily|| '—';
    $('#vJob').textContent    = p.job  || '—';
    $('#vSchool').textContent = p.school|| '—';
    $('#vFree').textContent   = p.free || '—';

    // 編集側にも反映
    $('#eName').value = p.name||'';
    $('#eAge').value  = p.age ||'';
    $('#eArea').value = p.area||'';
    $('#eHobby').value= p.hobby||'';
    $('#eLike').value = p.like||'';
    $('#eDaily').value= p.daily||'';
    $('#eJob').value  = p.job||'';
    $('#eSchool').value = p.school||'';
    $('#eFree').value = p.free||'';
  }

  function renderSub(){
    enforceSubValidity();
    const sub = get('sub') || {active:false};
    const active = isSubActive(sub);
    const pill = $('#subPill');
    const desc = $('#subDesc');

    if(active){
      pill.className = 'pill ok';
      pill.textContent = '加入中';
      desc.textContent = `プラン：${sub.plan||'ベーシック'}　次回更新日：${sub.nextRenewal||'-'}`;
    }else{
      pill.className = 'pill gray';
      pill.textContent = '未加入';
      desc.textContent = '申込み時に「サブスク加入して支払う」を選ぶと加入（デモボタンでも切替可）。';
    }
  }

  function renderKyc(){
    const kyc = get('kyc') || {};
    const pill = $('#kycPill');
    const gp = $('#kycGenderPill');

    if(kyc.verified){
      pill.className = 'pill ok';
      pill.textContent = '完了';
      gp.style.display = 'inline-flex';
      gp.textContent = kyc.gender==='female' ? '女性' : (kyc.gender==='male' ? '男性' : '—');
    }else{
      pill.className = 'pill warn';
      pill.textContent = '未完了';
      gp.style.display = 'none';
    }
  }

  function renderHistory(){
    const list = get('invite.list') || [];
    const el = $('#hist');
    if(!list.length){ el.textContent = 'まだ履歴がありません。'; return; }
    el.innerHTML = list.map(x => `<div class="field"><div class="label">${x.date}</div><div class="value" style="word-break:break-all">${x.url}</div></div>`).join('');
  }

  // --- イベント ---
  $('#uidCopy').addEventListener('click', async ()=>{
    const t = $('#uidTxt').textContent;
    try { await navigator.clipboard.writeText(t); alert('UIDをコピーしました'); }
    catch{ alert('コピーできませんでした'); }
  });

  $('#btnEdit').addEventListener('click', ()=>{
    $('#profView').style.display='none';
    $('#profEdit').style.display='block';
  });
  $('#btnEditCancel').addEventListener('click', ()=>{
    $('#profEdit').style.display='none';
    $('#profView').style.display='block';
  });
  $('#btnEditSave').addEventListener('click', async ()=>{
    const p = {
      name: $('#eName').value.trim(),
      age:  Number($('#eAge').value||0),
      area: $('#eArea').value,
      hobby:$('#eHobby').value, like:$('#eLike').value, daily:$('#eDaily').value,
      job: $('#eJob').value, school:$('#eSchool').value, free:$('#eFree').value
    };
    if(!p.name || !p.age || !p.area){ alert('ニックネーム・年齢・エリアは必須です'); return; }
    put('profile', p);
    renderProfile();
    $('#profEdit').style.display='none';
    $('#profView').style.display='block';

    // シートへ同期
    try{
      const prof = await liff.getProfile().catch(()=>({displayName:'', userId:''}));
      await SYNC.upsertUser({
        uid: localStorage.getItem(uidKey)||'',
        lineUserId: prof.userId || '',
        displayName: prof.displayName || '',
        profile: p,
        credit: Number(localStorage.getItem('credit')||'0'),
        kyc: get('kyc')||{},
        sub: get('sub')||{}
      });
    }catch(e){ console.warn(e); }
  });

  // KYC デモ
  $('#btnKycFemale').addEventListener('click', ()=>{ put('kyc',{verified:true, gender:'female'}); renderKyc(); });
  $('#btnKycMale').addEventListener('click', ()=>{ put('kyc',{verified:true, gender:'male'}); renderKyc(); });
  $('#btnKycReset').addEventListener('click', ()=>{ put('kyc',{verified:false}); renderKyc(); });

  // サブスク（デモ操作）
  $('#btnSubJoin').addEventListener('click', ()=>{
    const next = new Date(Date.now()+30*24*60*60*1000).toISOString().slice(0,10);
    put('sub',{active:true, plan:'basic', nextRenewal: next});
    renderSub();
  });
  $('#btnSubCancel').addEventListener('click', ()=>{
    put('sub',{active:false, plan:'basic', nextRenewal:null});
    renderSub();
  });

  // --- 初期化 ---
  document.addEventListener('DOMContentLoaded', async ()=>{
    try{
      await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login({redirectUri: location.href}); return; }
      const prof = await liff.getProfile();
      ensureAppUID(prof.userId);
      await SYNC.syncOnLogin(prof);
    }catch(e){
      console.warn(e);
      ensureAppUID('LOCAL-'+Date.now());
    }

    renderUID();
    renderProfile();
    renderSub();
    renderKyc();
    renderHistory();
  });
</script>
</body>
</html>
