<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>LIFF Minimal｜マイページ</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<!-- ファイル名に合わせてこちらに変更 -->
<script src="api.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --radius:16px; --tabbarH:88px; --fs:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
    line-height:1.6;font-size:var(--fs);overflow-x:hidden;touch-action:manipulation;
    writing-mode:horizontal-tb!important;-webkit-writing-mode:horizontal-tb!important;text-orientation:mixed!important;
  }
  header{position:sticky;top:0;z-index:10;background:var(--bg);padding:12px 16px 8px}
  .ttl{font-weight:800;font-size:18px}.sub{color:var(--muted);font-size:12px}
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px calc(var(--tabbarH) + 20px)}
  .card{background:#FFF;border:1px solid var(--border);border-radius:16px;padding:14px 16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;border-radius:14px;font-size:16px;padding:10px 14px;cursor:pointer}
  .btn.small{font-size:13px;padding:8px 12px;border-radius:12px}
  .row{display:flex;align-items:center;gap:10px}.between{justify-content:space-between}
  .kv{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed var(--border)}
  .label{color:#6B7280}
  .pill{display:inline-flex;align-items:center;justify-content:center;min-width:56px;padding:6px 10px;border-radius:999px;background:#E7EFE7;color:#10381F;font-weight:700}
  .ok{background:#E7F5ED;color:#065F46}.warn{background:#FEF3C7;color:#92400E}.gray{background:#F3F4F6;color:#111827}
  input,select,textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;font-size:16px}
  textarea{min-height:90px}
  .urlbox{padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:#FAFAF7;word-break:break-all}
  nav.tabbar{position:fixed;left:0;right:0;bottom:0;height:var(--tabbarH);background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:16px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;text-align:center}
  .tabicon{width:22px;height:22px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="ttl">マイページ</div>
  <div class="sub" id="siteSub"></div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row between">
      <div class="row" style="gap:8px">
        <div class="label">個別ID</div>
        <div id="uidText" style="font-weight:700">—</div>
      </div>
      <button id="copyUid" class="btn small">コピー</button>
    </div>
  </section>

  <section class="card" id="profView">
    <div class="row between">
      <div style="font-weight:700">プロフィール</div>
      <button id="editBtn" class="btn small">編集</button>
    </div>
    <div class="kv"><div class="label">ニックネーム</div><div id="v_name">—</div></div>
    <div class="kv"><div class="label">年齢</div><div id="v_age">—</div></div>
    <div class="kv"><div class="label">エリア</div><div id="v_area">—</div></div>
  </section>

  <section class="card" id="profEdit" style="display:none">
    <div class="row between"><div style="font-weight:700">プロフィールを編集</div></div>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <div style="flex:1 1 220px"><div class="label">ニックネーム（必須）</div><input id="f_name" /></div>
      <div style="width:120px"><div class="label">年齢（必須）</div><input id="f_age" type="number" min="18" max="80"/></div>
      <div style="flex:1 1 160px"><div class="label">エリア（必須）</div>
        <select id="f_area">
          <option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option>
          <option>名古屋</option><option>大阪</option><option>福岡</option>
        </select>
      </div>
      <div style="flex:1 1 220px"><div class="label">趣味</div><input id="f_hobby" /></div>
      <div style="flex:1 1 220px"><div class="label">好きなこと</div><input id="f_like" /></div>
      <div style="flex:1 1 220px"><div class="label">普段していること</div><input id="f_usually" /></div>
      <div style="flex:1 1 220px"><div class="label">職業</div><input id="f_job" /></div>
      <div style="flex:1 1 220px"><div class="label">学校</div><input id="f_school" /></div>
      <div style="flex:1 1 100%"><div class="label">自由記入</div><textarea id="f_free"></textarea></div>
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="cancelBtn" class="btn">キャンセル</button>
      <button id="saveBtn" class="btn" style="background:#0C7C59;color:#fff;border-color:#0C7C59">保存</button>
    </div>
  </section>

  <section class="card">
    <div class="row between">
      <div style="font-weight:700">本人確認</div>
      <span id="kycBadge" class="pill gray">未確認</span>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="asFemale" class="btn small">女性として確認済みにする</button>
      <button id="asMale" class="btn small">男性として確認済みにする</button>
    </div>
    <p class="note">※ 本番では外部eKYC連携を想定。ここではデモ切替のみ。</p>
  </section>

  <section class="card">
    <div class="row between"><div style="font-weight:700">クレジット残高</div><div><b id="credit">0</b> pt</div></div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="chargePlus" class="btn small">+1000pt</button>
      <button id="chargeMinus" class="btn small">-1000pt</button>
    </div>
  </section>

  <section class="card">
    <div style="font-weight:700">招待URL</div>
    <div class="urlbox" id="currentInvite">— 現在の招待：未発行 —</div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button id="copyInvite" class="btn small">現在の招待URLをコピー</button>
    </div>
    <div style="font-weight:700;margin-top:10px">履歴</div>
    <div id="histList" class="urlbox">— まだ履歴がありません —</div>
  </section>

  <section class="card">
    <div class="row between">
      <div style="font-weight:700">お知らせ</div>
      <button id="addNoti" class="btn small">テスト通知を追加</button>
    </div>
    <div id="notiList" style="margin-top:8px" class="urlbox">— まだお知らせはありません —</div>
  </section>
</main>

<nav class="tabbar">
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a class="active" href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  const $=s=>document.querySelector(s);
  const j=(k)=>JSON.parse(localStorage.getItem(k)||'null');
  const g=(k)=>localStorage.getItem(k);
  const s=(k,val)=>localStorage.setItem(k, typeof val==='string'? val: JSON.stringify(val));

  function hash36(str){
    let h=0;
    for(let i=0;i<str.length;i++){ h = (h*31 + str.charCodeAt(i))>>>0; }
    const b = h.toString(36).toUpperCase();
    return ('0000000'+b).slice(-7);
  }
  function ensureUIDSync(){
    let uid = g('appUID') || g('uid');
    if(!uid){
      uid = 'GX-' + Math.random().toString(36).slice(-7).toUpperCase();
      localStorage.setItem('appUID', uid);
      localStorage.setItem('uid', uid);
    }else{
      localStorage.setItem('appUID', uid);
      localStorage.setItem('uid', uid);
    }
    return uid;
  }
  async function ensureUIDAsync(){
    let uid = g('appUID') || g('uid');
    if(!uid && typeof liff!=='undefined' && liff && liff.getProfile){
      try{
        const prof = await liff.getProfile();
        const userId = prof && prof.userId;
        if(userId){
          uid = 'GX-' + hash36(userId + '|' + (location.hostname||''));
          localStorage.setItem('appUID', uid);
          localStorage.setItem('uid', uid);
        }
      }catch(e){}
    }
    if(!uid) uid = ensureUIDSync();
    return uid;
  }
  function renderUID(){ $('#uidText').textContent = g('appUID') || g('uid') || '—'; }

  function renderProfile(){
    const p=j('profile')||{};
    const name = p.name ?? g('prof.name') ?? '—';
    const age  = p.age  ?? g('prof.age')  ?? '—';
    const area = p.area ?? g('prof.area') ?? '—';
    $('#v_name').textContent = name || '—';
    $('#v_age').textContent  = age  || '—';
    $('#v_area').textContent = area || '—';
  }

  function fillForm(){
    const p=j('profile')||{};
    $('#f_name').value = (p.name ?? g('prof.name') ?? '');
    $('#f_age').value  = (p.age  ?? g('prof.age')  ?? '');
    $('#f_area').value = (p.area ?? g('prof.area') ?? '');
    $('#f_hobby').value   = (p.hobby   ?? g('prof.hobby')   ?? '');
    $('#f_like').value    = (p.like    ?? g('prof.like')    ?? '');
    $('#f_usually').value = (p.usually ?? g('prof.usually') ?? '');
    $('#f_job').value     = (p.job     ?? g('prof.job')     ?? '');
    $('#f_school').value  = (p.school  ?? g('prof.school')  ?? '');
    $('#f_free').value    = (p.free    ?? g('prof.free')    ?? '');
  }
  function toggleEdit(on){
    $('#profView').style.display = on?'none':'block';
    $('#profEdit').style.display = on?'block':'none';
    if(on) fillForm();
  }
  async function saveProfile(){
    const name=$('#f_name').value.trim(), age=$('#f_age').value.trim(), area=$('#f_area').value.trim();
    if(!name||!age||!area){ alert('ニックネーム・年齢・エリアは必須です。'); return; }
    const profile = {
      name, age, area,
      hobby:($('#f_hobby').value||'').trim(),
      like:($('#f_like').value||'').trim(),
      usually:($('#f_usually').value||'').trim(),
      job:($('#f_job').value||'').trim(),
      school:($('#f_school').value||'').trim(),
      free:($('#f_free').value||'').trim()
    };
    s('profile', profile);
    s('prof.name', profile.name); s('prof.age', profile.age); s('prof.area', profile.area);
    s('prof.hobby', profile.hobby); s('prof.like', profile.like); s('prof.usually', profile.usually);
    s('prof.job', profile.job); s('prof.school', profile.school); s('prof.free', profile.free);

    try{
      if(window.SYNC && SYNC.upsertUser){
        await SYNC.upsertUser({
          uid: g('appUID') || g('uid') || '',
          profile,
          credit: Number(g('credit')||0),
          kyc: {verified: g('kyc.verified')==='true', gender: g('kyc.gender')||''}
        });
      }
    }catch(e){ console.warn(e); }

    renderProfile();
    toggleEdit(false);
  }

  function setKyc(gender){ localStorage.setItem('kyc.verified','true'); localStorage.setItem('kyc.gender',gender); renderKyc(); }
  function renderKyc(){
    const v = g('kyc.verified')==='true'; const gender=g('kyc.gender')||'';
    $('#kycBadge').textContent = v? (gender==='female'?'本人確認済（女性）': gender==='male'?'本人確認済（男性）':'本人確認済') : '未確認';
    $('#kycBadge').className = 'pill '+(v?'ok':'warn');
  }

  function setCredit(vl){ localStorage.setItem('credit', String(vl)); $('#credit').textContent = vl; }
  function renderCredit(){ $('#credit').textContent = Number(g('credit')||0); }

  function getNoti(){ return j('noti.items') || j('notifications') || []; }
  function setNoti(arr){ s('noti.items', arr); s('notifications', arr); }
  function renderNoti(){
    const arr=getNoti();
    if(!arr.length){ $('#notiList').textContent='— まだお知らせはありません —'; return; }
    $('#notiList').innerHTML = arr.map(n=>`<div>・${(n.date||'').toString()}：${n.text||''}</div>`).join('');
  }

  function formatRemain(iso){
    if(!iso) return '—';
    const d = new Date(iso+'T00:00:00'); const today=new Date(); d.setHours(0,0,0,0); today.setHours(0,0,0,0);
    const diff = Math.ceil((d-today)/86400000);
    return diff>=0? `残り ${diff}日` : '期限切れ';
  }
  function renderInvites(){
    const cur = j('invite.current') || {url:'', expire:''};
    $('#currentInvite').innerHTML = cur.url ? (`<div>現在の招待URL：<b>${cur.url}</b></div><div class="note">期限：${cur.expire||'—'}（${formatRemain(cur.expire)}）</div>`)
                                             : '— 現在の招待：未発行 —';
    const hist = j('invite.history') || [];
    $('#histList').innerHTML = hist.length ? hist.map(x=>`<div>・${x.date||''}　${x.url||''}</div>`).join('')
                                           : '— まだ履歴がありません —';
  }

  $('#copyUid').addEventListener('click',async()=>{
    try{ await navigator.clipboard.writeText($('#uidText').textContent||''); alert('個別IDをコピーしました'); }catch{}
  });
  $('#editBtn').addEventListener('click',()=>toggleEdit(true));
  $('#cancelBtn').addEventListener('click',()=>toggleEdit(false));
  $('#saveBtn').addEventListener('click',saveProfile);

  $('#asFemale').addEventListener('click',()=>setKyc('female'));
  $('#asMale').addEventListener('click',()=>setKyc('male'));
  $('#chargePlus').addEventListener('click',()=>setCredit(Number(g('credit')||0)+1000));
  $('#chargeMinus').addEventListener('click',()=>setCredit(Math.max(0, Number(g('credit')||0)-1000)));
  $('#addNoti').addEventListener('click',()=>{
    const arr=getNoti(); arr.unshift({date:new Date().toISOString().slice(0,19).replace('T',' '), text:'テスト通知'}); setNoti(arr); renderNoti();
  });
  $('#copyInvite').addEventListener('click',async()=>{
    const cur=j('invite.current')||{}; if(!(cur.url||'')){ alert('現在の招待URLがありません'); return; }
    try{ await navigator.clipboard.writeText(cur.url); alert('招待URLをコピーしました'); }catch{}
  });

  // --- LIFF ID 自動解決 & ログインループ対策 ---
  function resolveLiffId(){
    if (window.APP && APP.LIFF_ID) return APP.LIFF_ID;
    const host = location.hostname;
    if (/^(miniapp\.line\.me|liff\.line\.me|liff\.line-apps\.com)$/i.test(host)) {
      const seg = location.pathname.split('?')[0].split('/').filter(Boolean)[0];
      if (seg) return seg;
    }
    return "2008178197-ELrxabO9";
  }
  const LoginGuard = {
    key: 'liff_login_once',
    ttlMs: 180000,
    now(){ return Date.now(); },
    mark(){ sessionStorage.setItem(this.key, String(this.now())); },
    clear(){ sessionStorage.removeItem(this.key); },
    hasRecentlyTried(){
      const t = Number(sessionStorage.getItem(this.key)||0);
      if(!t) return false;
      return (this.now()-t) < this.ttlMs;
    }
  };
  function hasOAuthReturnParams(){
    const q = new URLSearchParams(location.search);
    return q.has('liff.state') || q.has('code') || q.has('state');
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    $('#siteSub').textContent = location.hostname.replace(/^www\./,'');

    await ensureUIDAsync();
    renderUID(); renderProfile(); renderKyc(); renderCredit(); renderInvites(); renderNoti();

    // 強固な LIFF 初期化（外部のみ1回ログイン）
    try{
      const LIFF_ID = resolveLiffId();
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      const inClient = liff.isInClient();

      if(!inClient){
        if(!liff.isLoggedIn()){
          if(!LoginGuard.hasRecentlyTried()){
            LoginGuard.mark();
            const cleanUrl = location.origin + location.pathname + location.search;
            liff.login({ redirectUri: cleanUrl });
            return;
          } else if(hasOAuthReturnParams()){
            LoginGuard.clear();
          }
        } else {
          LoginGuard.clear();
        }
      }
    }catch(e){ console.warn('LIFF init/login error', e); }

    // 同期系（ログイン状態が取れたら同期）
    try{
      if(window.SYNC && SYNC.syncOnLogin){
        const prof = await liff.getProfile().catch(()=>null);
        if(prof){ await SYNC.syncOnLogin(prof); }
        await ensureUIDAsync();
        renderUID();
      }
    }catch(e){ console.warn(e); }
  });
</script>
</body>
</html>
