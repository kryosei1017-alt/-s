<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>LIFF Minimalï½œãƒã‚¤ãƒšãƒ¼ã‚¸</title>
<meta name="theme-color" content="#F6F3EE">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{ --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59; --border:#E5E7EB; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;line-height:1.6;overflow-x:hidden;}
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px 112px}
  header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px}
  .hrow{display:flex;align-items:center;gap:10px}
  .ttl{font-weight:800;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:14px 16px;border-radius:14px;font-size:16px;cursor:pointer}
  .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  label{display:block;font-size:14px;margin:10px 0 6px}
  input, textarea, select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
  textarea{min-height:88px;resize:vertical}
  .tabbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center}
  .tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:#0C7C59}
  .avatar{width:64px;height:64px;border-radius:50%;background:#D1D5DB;display:grid;place-items:center;font-weight:700;overflow:hidden}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid}
  .b-gray{color:#374151;border-color:#D1D5DB;background:#F3F4F6}
  .b-warn{color:#92400e;border-color:#FCD34D;background:#FFFBEB}
  .b-ok{color:#065f46;border-color:#6EE7B7;background:#ECFDF5}
  .b-ng{color:#991b1b;border-color:#FCA5A5;background:#FEF2F2}
  .preview{display:flex;gap:10px;align-items:center;margin-top:8px}
  .preview img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#fff}
  .note{font-size:12px;color:#6B7280}
  .req{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:8px;background:#FEE2E2;color:#991B1B;font-size:11px;font-weight:700}
  .err{color:#991B1B;font-size:12px;display:none;margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="ttl">ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    <div class="sub">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« / ã‚µãƒ–ã‚¹ã‚¯ / æœ¬äººç¢ºèª</div>
  </div>
</header>

<main class="wrap">
  <section>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="card">
      <div class="hrow" style="justify-content:space-between;align-items:center">
        <div class="hrow" style="gap:12px;align-items:center">
          <div id="avatar" class="avatar">ğŸ™‚</div>
          <div>
            <div class="ttl" id="uname">â€”</div>
            <div class="sub" id="uid">â€”</div>
          </div>
        </div>
        <button class="btn" id="btnLogout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
    <div class="card">
      <div class="ttl" style="font-size:16px">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>

      <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  <span class="req">å¿…é ˆ</span>
        <input id="edNick" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " required>
      </label>
      <div id="errNick" class="err">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>

      <label>ã‚¨ãƒªã‚¢ <span class="req">å¿…é ˆ</span>
        <input id="edArea" placeholder="ä¾‹ï¼šæ±äº¬ / å¤§é˜ª / åå¤å±‹ ãªã©" required>
      </label>
      <div id="errArea" class="err">ã‚¨ãƒªã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>

      <label>å¹´é½¢ <span class="req">å¿…é ˆ</span>
        <input id="edAge" type="number" min="18" max="99" placeholder="ä¾‹ï¼š25" required>
      </label>
      <div id="errAge" class="err">å¹´é½¢ã¯18ã€œ99ã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>

      <label>è¶£å‘³
        <input id="edHobby" placeholder="ä¾‹ï¼šã‚«ãƒ•ã‚§å·¡ã‚Šã€ã‚µã‚¦ãƒŠã€ã‚µãƒƒã‚«ãƒ¼">
      </label>

      <label>å¥½ããªã“ã¨
        <input id="edLike" placeholder="ä¾‹ï¼šæ˜ ç”»ã€æ—…è¡Œã€æ–™ç†">
      </label>

      <label>æ™®æ®µä½•ã—ã¦ã‚‹ï¼ˆãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
        <textarea id="edRoutine" placeholder="ä¾‹ï¼šå¹³æ—¥ã¯ITä¼æ¥­ã§å‹¤å‹™ã€é€±æœ«ã¯ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ãªã©"></textarea>
      </label>

      <label>ä»•äº‹
        <input id="edJob" placeholder="ä¾‹ï¼šå–¶æ¥­ / ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ / åŒ»ç™‚ ãªã©">
      </label>

      <label>å­¦æ ¡
        <input id="edSchool" placeholder="ä¾‹ï¼šâ—¯â—¯å¤§å­¦ / â—¯â—¯å°‚é–€å­¦æ ¡ ãªã©">
      </label>

      <label>è‡ªç”±è¨˜å…¥
        <textarea id="edFree" placeholder="è‡ªå·±PRã‚„å¸Œæœ›æ¡ä»¶ãªã©è‡ªç”±ã«å…¥åŠ›"></textarea>
      </label>

      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="edSave">ä¿å­˜</button>
      </div>
    </div>

    <!-- KYC -->
    <div class="card">
      <div class="ttl" style="font-size:16px">æœ¬äººç¢ºèªï¼ˆKYCï¼‰ <span id="badge" class="badge b-gray">æœªæå‡º</span></div>
      <div class="note">â€» ãƒ”ãƒ³ã¼ã‘ãƒ»åå°„ãƒ»ãƒã‚¹ã‚¯ãƒ»åŠ å·¥ã¯å¯©æŸ»NGã®åŸå› ã«ãªã‚Šã¾ã™ã€‚æ˜ã‚‹ã„å ´æ‰€ã§ã€å››éš…ãŒå…¥ã‚‹ã‚ˆã†æ’®å½±ã—ã¦ãã ã•ã„ã€‚</div>

      <div class="row" style="margin-top:10px">
        <select id="docType" style="flex:1">
          <option value="license">é‹è»¢å…è¨±è¨¼</option>
          <option value="myNumber">ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰</option>
          <option value="passport">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</option>
        </select>

        <label class="btn" style="flex:1;text-align:center">
          èº«åˆ†è¨¼ã‚’é¸æŠ<input id="docFile" type="file" accept="image/*" capture="environment" style="display:none">
        </label>
        <label class="btn" style="flex:1;text-align:center">
          ã‚»ãƒ«ãƒ•ã‚£ãƒ¼<input id="selfieFile" type="file" accept="image/*" capture="user" style="display:none">
        </label>
      </div>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & å†æ’®å½± -->
      <div class="preview" id="docPreview" style="display:none">
        <img id="docImg" alt="">
        <div class="note" style="flex:1">èº«åˆ†è¨¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <button class="btn" id="docRetake">å†æ’®å½±ï¼ˆèº«åˆ†è¨¼ï¼‰</button>
      </div>
      <div class="preview" id="selfiePreview" style="display:none">
        <img id="selfieImg" alt="">
        <div class="note" style="flex:1">ã‚»ãƒ«ãƒ•ã‚£ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <button class="btn" id="selfieRetake">å†æ’®å½±ï¼ˆã‚»ãƒ«ãƒ•ã‚£ãƒ¼ï¼‰</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="kycReset">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn primary" id="kycSubmit" disabled>æå‡ºã™ã‚‹</button>
      </div>
    </div>

    <!-- ã‚µãƒ–ã‚¹ã‚¯ -->
    <div class="card">
      <div class="ttl" style="font-size:16px">ã‚µãƒ–ã‚¹ã‚¯</div>
      <div id="subStatus">æœªåŠ å…¥</div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnJoinSub">åŠ å…¥</button>
        <button class="btn" id="btnCancelSub">è§£ç´„</button>
      </div>
    </div>

    <!-- å±¥æ­´ã‚«ãƒ¼ãƒ‰ã¯å‰Šé™¤æ¸ˆã¿ -->
  </section>
</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ãƒ›ãƒ¼ãƒ </a>
  <a href="apply.html"><span class="tabicon"></span>ç”³è¾¼ã¿</a>
  <a class="active" href="mypage.html"><span class="tabicon"></span>ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
</nav>

<script>
  const APP = { LIFF_ID:"2008178197-ELrxabO9", API:"https://script.google.com/macros/s/AKfycbzvAK9-fg02CJAmAO73XyuaN3HjF0k0bDncAxtWdn2MVOhTub1T9hT8bSs9XG0_4qxC/exec" };
  const STATE = {
    profile: JSON.parse(localStorage.getItem("profile")||"{}"),
    sub: JSON.parse(localStorage.getItem("sub")||"{}"),
    kyc: JSON.parse(localStorage.getItem("kyc")||"{}") // {status, doc:{...}, selfie:{...}}
  };
  const AUTH = { userId:"", idToken:"" };
  const $=s=>document.querySelector(s);

  // æ—§ã‚­ãƒ¼ã‹ã‚‰ã®ç§»è¡Œï¼ˆåˆå›ã®ã¿ï¼‰
  (function migrate(){
    if(STATE.profile){
      if(!STATE.profile.area && STATE.profile.pref){ STATE.profile.area = STATE.profile.pref; }
      delete STATE.profile.pref; delete STATE.profile.city; delete STATE.profile.radius;
      localStorage.setItem("profile", JSON.stringify(STATE.profile));
    }
  })();

  function save(){
    localStorage.setItem("profile", JSON.stringify(STATE.profile));
    localStorage.setItem("sub", JSON.stringify(STATE.sub));
    localStorage.setItem("kyc", JSON.stringify(STATE.kyc));
  }

  function setBadge(status){
    const b = $("#badge");
    b.className = "badge b-gray";
    b.textContent = status || "æœªæå‡º";
    if(status==="å¯©æŸ»ä¸­"){ b.className = "badge b-warn"; }
    if(status==="æ‰¿èªæ¸ˆã¿"){ b.className = "badge b-ok"; }
    if(status==="å·®ã—æˆ»ã—"){ b.className = "badge b-ng"; }
  }

  function render(){
    $("#edNick").value   = STATE.profile.nick  || "";
    $("#edArea").value   = STATE.profile.area  || "";
    $("#edAge").value    = (STATE.profile.age!=null? STATE.profile.age : "");
    $("#edHobby").value  = STATE.profile.hobby || "";
    $("#edLike").value   = STATE.profile.like  || "";
    $("#edRoutine").value= STATE.profile.routine || "";
    $("#edJob").value    = STATE.profile.job   || "";
    $("#edSchool").value = STATE.profile.school|| "";
    $("#edFree").value   = STATE.profile.free  || "";

    $("#subStatus").textContent = STATE.sub.active ? `åŠ å…¥ä¸­ï¼ˆ${STATE.sub.plan||'ãƒ™ãƒ¼ã‚·ãƒƒã‚¯'}ï¼‰` : "æœªåŠ å…¥";

    setBadge(STATE.kyc.status || "æœªæå‡º");
    $("#kycSubmit").disabled = !(STATE.kyc.doc && STATE.kyc.selfie);

    if(STATE.kyc.doc && STATE.kyc.doc.preview){ $("#docPreview").style.display = "flex"; $("#docImg").src = STATE.kyc.doc.preview; }
    else { $("#docPreview").style.display = "none"; }
    if(STATE.kyc.selfie && STATE.kyc.selfie.preview){ $("#selfiePreview").style.display = "flex"; $("#selfieImg").src = STATE.kyc.selfie.preview; }
    else { $("#selfiePreview").style.display = "none"; }
  }

  async function postJSON(url, body){
    const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
    if(!res.ok) throw new Error("HTTP "+res.status);
    return await res.json();
  }
  async function sendAction(type,payload){ try{ await postJSON(APP.API,{ type, payload, auth:AUTH }); }catch(e){ console.warn(e); } }

  // File -> b64 + previewURL
  function fileToData(f){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{
        const dataUrl = reader.result; // data:image/...;base64,xxxx
        const base64 = String(dataUrl).split(',')[1];
        resolve({ name:f.name, type:f.type||"image/jpeg", data: base64, preview: URL.createObjectURL(f) });
      };
      reader.onerror = reject;
      reader.readAsDataURL(f);
    });
  }

  function validate(){
    let ok = true;
    const nick = $("#edNick").value.trim();
    const area = $("#edArea").value.trim();
    const ageVal = $("#edAge").value.trim();
    const ageNum = parseInt(ageVal,10);

    $("#errNick").style.display = nick ? "none":"block";
    $("#errArea").style.display = area ? "none":"block";
    const ageValid = !!ageVal && Number.isInteger(ageNum) && ageNum>=18 && ageNum<=99;
    $("#errAge").style.display = ageValid ? "none":"block";

    if(!nick || !area || !ageValid) ok=false;
    return ok;
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    // LIFFãƒ­ã‚°ã‚¤ãƒ³
    try{
      await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser: true });
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
      const prof=await liff.getProfile();
      AUTH.userId = prof.userId || "";
      $("#uname").textContent = prof.displayName || "ãƒ¦ãƒ¼ã‚¶ãƒ¼";
      $("#uid").textContent = AUTH.userId;
      if(prof.pictureUrl){
        $("#avatar").innerHTML = `<img src="${prof.pictureUrl}" alt="" style="width:100%;height:100%;object-fit:cover">`;
      }
      if(!STATE.profile.nick){ STATE.profile.nick = prof.displayName || "ãƒ¦ãƒ¼ã‚¶ãƒ¼"; save(); }
    }catch(e){ console.warn(e); }

    // ä¿å­˜
    $("#edSave").addEventListener("click", ()=>{
      if(!validate()) return;
      STATE.profile = {
        nick:   $("#edNick").value.trim(),
        area:   $("#edArea").value.trim(),
        age:    parseInt($("#edAge").value,10),
        hobby:  $("#edHobby").value.trim(),
        like:   $("#edLike").value.trim(),
        routine:$("#edRoutine").value.trim(),
        job:    $("#edJob").value.trim(),
        school: $("#edSchool").value.trim(),
        free:   $("#edFree").value.trim()
      };
      save(); render(); sendAction("update_profile", STATE.profile);
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    });

    // KYCãƒ•ã‚¡ã‚¤ãƒ«
    $("#docFile").addEventListener("change", async (e)=>{
      const f=e.target.files && e.target.files[0]; if(!f) return;
      STATE.kyc.doc = await fileToData(f);
      save(); render();
    });
    $("#selfieFile").addEventListener("change", async (e)=>{
      const f=e.target.files && e.target.files[0]; if(!f) return;
      STATE.kyc.selfie = await fileToData(f);
      save(); render();
    });

    // å†æ’®å½±å°ç·š
    $("#docRetake").addEventListener("click", ()=> $("#docFile").click());
    $("#selfieRetake").addEventListener("click", ()=> $("#selfieFile").click());

    $("#kycReset").addEventListener("click", ()=>{ STATE.kyc = {}; save(); render(); });

    $("#kycSubmit").addEventListener("click", async ()=>{
      if(!(STATE.kyc.doc && STATE.kyc.selfie)){ alert("èº«åˆ†è¨¼ã¨ã‚»ãƒ«ãƒ•ã‚£ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      STATE.kyc.status = "å¯©æŸ»ä¸­"; save(); render();
      await sendAction("kyc_upload", { doc: STATE.kyc.doc, selfie: STATE.kyc.selfie });
      alert("æå‡ºã—ã¾ã—ãŸã€‚å¯©æŸ»ä¸­ã§ã™ã€‚");
    });

    // ã‚µãƒ–ã‚¹ã‚¯
    $("#btnJoinSub").addEventListener("click", ()=>{ STATE.sub={active:true, plan:"ãƒ™ãƒ¼ã‚·ãƒƒã‚¯", since:new Date().toISOString()}; save(); render(); sendAction("subscribe", STATE.sub); });
    $("#btnCancelSub").addEventListener("click", ()=>{ STATE.sub={active:false}; save(); render(); sendAction("unsubscribe", {}); });
    $("#btnLogout").addEventListener("click", ()=>{ try{ if(window.liff && liff.isLoggedIn()) liff.logout(); }catch{} });

    render();
  });
</script>
</body>
</html>
