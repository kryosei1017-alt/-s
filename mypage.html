<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>LIFF Minimal｜マイページ</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
:root{ --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59; --border:#E5E7EB; --radius:16px; --fs:13px; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;line-height:1.6;overflow-x:hidden;font-size:var(--fs);touch-action:manipulation;}
.wrap{max-width:720px;margin:0 auto;padding:12px 16px 112px}
header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px}
.hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ttl{font-weight:800;font-size:18px}
.sub{color:var(--muted)}
.card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
.btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:12px 14px;border-radius:14px;font-size:14px;cursor:pointer}
.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.row{display:flex;gap:10px;align-items:center}
input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
.badge{display:inline-block;background:#E7EFE7;color:#0b5b42;border-radius:999px;padding:4px 8px;font-weight:700}
.tabbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
.tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center}
.tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
.tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
</style>
</head>
<body>
<header><div class="hrow"><div class="ttl">マイページ</div><span class="badge" id="uid">—</span></div></header>
<main class="wrap">

  <section class="card">
    <div class="hrow" style="justify-content:space-between">
      <div class="ttl" style="font-size:17px">プロフィール</div>
      <button class="btn" id="editBtn">編集</button>
    </div>

    <div id="profView" class="sub"></div>

    <div id="profForm" style="display:none;margin-top:10px">
      <label>ニックネーム（必須）<input id="pfName" /></label>
      <label style="margin-top:8px">年齢（必須）<input id="pfAge" type="number" min="18" max="80" /></label>
      <label style="margin-top:8px">エリア（必須）
        <select id="pfArea"><option value="">選択してください</option><option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option><option>名古屋</option><option>大阪</option><option>福岡</option></select>
      </label>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" id="cancelEdit">キャンセル</button>
        <button class="btn primary" id="saveProf">保存</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="ttl" style="font-size:17px">本人確認</div>
    <div class="row" style="gap:8px">
      <span class="badge" id="kycBadge">未確認</span>
      <button class="btn" id="kycMale">男性で確認（デモ）</button>
      <button class="btn" id="kycFemale">女性で確認（デモ）</button>
      <button class="btn" id="kycReset">リセット</button>
    </div>
  </section>

  <section class="card">
    <div class="ttl" style="font-size:17px">問い合わせ</div>
    <div class="sub">ご不明点はLINEでお問い合わせください。</div>
  </section>

</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a class="active" href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
const APP={ LIFF_ID:"2008178197-ELrxabO9" };
const $=s=>document.querySelector(s);

function ensureUID(){
  let uid = localStorage.getItem('appUID');
  if(!uid){
    uid='GX-'+Math.random().toString(36).slice(2,6).toUpperCase()+'-'+Date.now().toString().slice(-6);
    localStorage.setItem('appUID',uid);
  }
  $("#uid").textContent = localStorage.getItem('appUID');
}

function renderProf(){
  const p = JSON.parse(localStorage.getItem('profile')||'{}');
  $("#profView").innerHTML = `
    <div>ニックネーム：${p.name||'—'}</div>
    <div>年齢：${p.age||'—'}</div>
    <div>エリア：${p.area||'—'}</div>
  `;
  $("#pfName").value = p.name||'';
  $("#pfAge").value  = p.age||'';
  $("#pfArea").value = p.area||'';
}

function renderKyc(){
  const k=JSON.parse(localStorage.getItem('kyc')||'{}');
  $("#kycBadge").textContent = k.verified ? `確認済み（${k.gender||'不明'}）` : '未確認';
}

document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
    ensureUID();
    const pf=await liff.getProfile(); await SYNC.syncOnLogin(pf);
  }catch(e){ console.warn(e); }

  renderProf(); renderKyc();

  $("#editBtn").addEventListener('click', ()=>{ $("#profForm").style.display='block'; });
  $("#cancelEdit").addEventListener('click', ()=>{ $("#profForm").style.display='none'; renderProf(); });

  $("#saveProf").addEventListener('click', async ()=>{
    const name=$("#pfName").value.trim(); const age=$("#pfAge").value.trim(); const area=$("#pfArea").value.trim();
    if(!name||!age||!area){ alert('ニックネーム・年齢・エリアは必須です'); return; }
    localStorage.setItem('profile', JSON.stringify({name, age, area}));
    $("#profForm").style.display='none'; renderProf();
    await SYNC.syncNow();
    alert('保存しました');
  });

  $("#kycMale").addEventListener('click', async ()=>{ localStorage.setItem('kyc', JSON.stringify({verified:true, gender:'male'})); renderKyc(); await SYNC.syncNow(); });
  $("#kycFemale").addEventListener('click', async ()=>{ localStorage.setItem('kyc', JSON.stringify({verified:true, gender:'female'})); renderKyc(); await SYNC.syncNow(); });
  $("#kycReset").addEventListener('click', async ()=>{ localStorage.setItem('kyc', JSON.stringify({verified:false})); renderKyc(); await SYNC.syncNow(); });
});
</script>
</body>
</html>
