<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>LIFF Minimal｜マイページ</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{--bg:#F6F3EE;--card:#FFF;--ink:#1F2937;--muted:#6B7280;--accent:#0C7C59;--border:#E5E7EB;--radius:16px;--tabbarH:96px;--headerH:56px;--fs:13px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;line-height:1.6;overflow-x:hidden;font-size:var(--fs);writing-mode:horizontal-tb!important}
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px calc(var(--tabbarH) + 16px);min-height:calc(100dvh - var(--headerH) - var(--tabbarH));display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px;min-height:var(--headerH);display:flex;align-items:center}
  .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ttl{font-weight:800;font-size:18px}
  .sub{color:var(--muted);font-size:var(--fs)}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:12px 14px;border-radius:12px;font-size:var(--fs);cursor:pointer}
  .btn--sm{min-width:92px}
  .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .danger{background:#fff;border-color:#fecaca;color:#7f1d1d}
  .card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  label{display:block;margin:8px 0 6px;font-size:var(--fs)}
  input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:var(--fs)}
  textarea{min-height:88px;resize:vertical}
  .muted{color:#6B7280}
  .grid-def{display:grid;grid-template-columns: 9em 1fr;gap:10px 12px}
  .val{font-weight:600}
  .placeholder{color:#9CA3AF}
  .list{display:flex;flex-direction:column;gap:10px}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:var(--fs);border:1px solid var(--border);background:#fff}
  .badge.ok{border-color:#86efac;background:#ecfdf5;color:#065f46}
  .badge.ng{border-color:#fecaca;background:#fff1f2;color:#7f1d1d}
  .tabbar{position:fixed;left:0;right:0;bottom:0;height:var(--tabbarH);background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center;font-size:var(--fs)}
  .tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="ttl">マイページ</div>
    <div class="sub">プロフィール・本人確認・履歴・問い合わせ</div>
  </div>
</header>

<main class="wrap">
  <!-- 個別ID -->
  <div class="card">
    <div class="hrow" style="justify-content:space-between;align-items:center">
      <div class="ttl" style="font-size:16px">あなたの個別ID</div>
      <button class="btn btn--sm" id="copyUID">コピー</button>
    </div>
    <p class="mono" id="uidText" style="word-break:break-all;margin:8px 0 0">—</p>
    <p class="sub" style="margin-top:6px">友だちにこのIDを伝えてください（改行で複数入力可）。</p>
  </div>

  <!-- プロフィール（閲覧） -->
  <div class="card" id="profileView">
    <div class="hrow" style="justify-content:space-between;align-items:center">
      <div class="ttl" style="font-size:16px">プロフィール</div>
      <button class="btn btn--sm" id="editBtn">編集</button>
    </div>
    <div class="grid-def" style="margin-top:8px">
      <div class="muted">ニックネーム</div><div class="val" id="vName"></div>
      <div class="muted">エリア</div><div class="val" id="vArea"></div>
      <div class="muted">年齢</div><div class="val" id="vAge"></div>
      <div class="muted">趣味</div><div class="val" id="vHobby"></div>
      <div class="muted">好きなこと</div><div class="val" id="vLike"></div>
      <div class="muted">普段何してる</div><div class="val" id="vDaily"></div>
      <div class="muted">仕事</div><div class="val" id="vJob"></div>
      <div class="muted">学校</div><div class="val" id="vSchool"></div>
      <div class="muted">自由記入</div><div class="val" id="vFree"></div>
    </div>
    <p class="sub" style="margin-top:8px">※ ニックネーム・エリア・年齢は申込みに必須です。</p>
  </div>

  <!-- プロフィール（編集） -->
  <div class="card" id="profileEdit" style="display:none">
    <div class="hrow" style="justify-content:space-between;align-items:center">
      <div class="ttl" style="font-size:16px">プロフィール編集</div>
      <div class="hrow" style="gap:8px">
        <button class="btn btn--sm" id="cancelEdit">やめる</button>
        <button class="btn primary btn--sm" id="saveEdit">保存</button>
      </div>
    </div>
    <label>ニックネーム（必須）<input id="fName" placeholder="例：りょう"></label>
    <label>エリア（必須）
      <select id="fArea">
        <option value="">選択してください</option>
        <option value="東京">東京</option><option value="横浜">横浜</option><option value="千葉">千葉</option>
        <option value="埼玉">埼玉</option><option value="名古屋">名古屋</option><option value="大阪">大阪</option><option value="福岡">福岡</option>
      </select>
    </label>
    <label>年齢（必須）<input id="fAge" type="number" min="18" max="60" placeholder="例：25"></label>
    <label>趣味<input id="fHobby" placeholder="例：サウナ、カフェ巡り"></label>
    <label>好きなこと<input id="fLike" placeholder="例：映画、旅行"></label>
    <label>普段何してる<input id="fDaily" placeholder="例：学生、IT勤務など"></label>
    <label>仕事<input id="fJob" placeholder="例：エンジニア"></label>
    <label>学校<input id="fSchool" placeholder="例：○○大学"></label>
    <label>自由記入<textarea id="fFree" placeholder="自己紹介など自由に"></textarea></label>
  </div>

  <!-- 本人確認（デモ） -->
  <div class="card" id="kycCard">
    <div class="hrow" style="justify-content:space-between;align-items:center">
      <div class="ttl" style="font-size:16px">本人確認（デモ）</div>
      <div id="kycBadge" class="badge">状態取得中...</div>
    </div>
    <p class="sub">外部eKYC導入までの仮実装です。ここでの状態は申込み画面と連動します。</p>
    <div class="chips" id="chipsKyc"><span class="chip" data-v="none">未完了</span><span class="chip" data-v="male">男性で確認済み</span><span class="chip" data-v="female">女性で確認済み</span></div>
  </div>

  <!-- 履歴（招待URL） -->
  <div class="card" id="historyCard">
    <div class="ttl" style="font-size:16px">履歴（招待URL）</div>
    <div id="histList" class="list" style="margin-top:8px"></div>
  </div>

  <!-- 問い合わせ -->
  <div class="card" id="contactCard">
    <div class="ttl" style="font-size:16px">問い合わせ</div>
    <label>内容<textarea id="qBody" placeholder="ご要望・不具合など"></textarea></label>
    <div class="hrow" style="justify-content:flex-end"><button id="qSend" class="btn primary btn--sm">送信（デモ）</button></div>
  </div>
</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a class="active" href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  window.addEventListener('gesturestart', e => e.preventDefault());
  const APP={ LIFF_ID:"2008178197-ELrxabO9" };
  const $=s=>document.querySelector(s);

  // 個別ID
  function makeUID(src){ let h=5381; for(let i=0;i<src.length;i++){ h=((h<<5)+h)^src.charCodeAt(i);} const n=(h>>>0).toString(36).toUpperCase().padStart(7,'0'); return "GX-"+n; }
  function ensureAppUID(lineUserId){ if(lineUserId && !localStorage.getItem("appUID")) localStorage.setItem("appUID", makeUID(lineUserId)); }
  function renderUID(){ $("#uidText").textContent = localStorage.getItem("appUID") || "—"; }
  $("#copyUID").addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(localStorage.getItem("appUID")||""); $("#copyUID").textContent="コピー済み"; setTimeout(()=>$("#copyUID").textContent="コピー",1000);}catch(e){ alert("コピーできませんでした"); } });

  // プロフィール
  const getProf=()=> JSON.parse(localStorage.getItem("profile")||"{}");
  const setProf=p => localStorage.setItem("profile", JSON.stringify(p));
  function renderProfileView(){
    const p=getProf();
    const v=(k)=> p[k] ? p[k] : "<span class='placeholder'>— 未設定 —</span>";
    $("#vName").innerHTML=v("name"); $("#vArea").innerHTML=v("area"); $("#vAge").innerHTML=v("age");
    $("#vHobby").innerHTML=v("hobby"); $("#vLike").innerHTML=v("like"); $("#vDaily").innerHTML=v("daily");
    $("#vJob").innerHTML=v("job"); $("#vSchool").innerHTML=v("school"); $("#vFree").innerHTML=v("free");
  }
  function openEdit(){
    const p=getProf(); $("#fName").value=p.name||""; $("#fArea").value=p.area||""; $("#fAge").value=p.age||"";
    $("#fHobby").value=p.hobby||""; $("#fLike").value=p.like||""; $("#fDaily").value=p.daily||"";
    $("#fJob").value=p.job||""; $("#fSchool").value=p.school||""; $("#fFree").value=p.free||"";
    $("#profileView").style.display="none"; $("#profileEdit").style.display="block";
  }
  function closeEdit(){ $("#profileEdit").style.display="none"; $("#profileView").style.display="block"; }
  $("#editBtn").addEventListener("click", openEdit); $("#cancelEdit").addEventListener("click", closeEdit);
  $("#saveEdit").addEventListener("click", ()=>{
    const p={
      name:$("#fName").value.trim(), area:$("#fArea").value, age:$("#fAge").value.trim(),
      hobby:$("#fHobby").value, like:$("#fLike").value, daily:$("#fDaily").value,
      job:$("#fJob").value, school:$("#fSchool").value, free:$("#fFree").value
    };
    if(!p.name || !p.area || !p.age){ alert("ニックネーム・エリア・年齢は必須です"); return; }
    setProf(p); renderProfileView(); closeEdit();
  });

  // KYC（デモ）
  const getKyc=()=> JSON.parse(localStorage.getItem("kyc")||'{"verified":false}');
  const setKyc=v => localStorage.setItem("kyc", JSON.stringify(v));
  function renderKyc(){
    const k=getKyc(); const badge=$("#kycBadge");
    if(k.verified){ badge.className="badge ok"; badge.textContent=`KYC: 済（${k.gender==="female"?"女性":"男性"}）`; }
    else { badge.className="badge ng"; badge.textContent="KYC: 未完了"; }
  }
  function chipGroup(el, init){ const f=v=>{ [...el.querySelectorAll(".chip")].forEach(x=>x.classList.toggle("active",x.dataset.v===v)); el.dataset.value=v; }; el.addEventListener("click",e=>{ const t=e.target.closest(".chip"); if(t) f(t.dataset.v); }); if(init) f(init); return ()=> el.dataset.value||""; }
  const getKycChip = chipGroup($("#chipsKyc"), getKyc().verified ? getKyc().gender : "none");
  $("#chipsKyc").addEventListener("click", ()=>{
    const v=getKycChip(); if(v==="none"){ setKyc({verified:false}); } else { setKyc({verified:true, gender:v}); }
    renderKyc();
  });

  // 履歴（招待URL）
  function renderHistory(){
    const list=JSON.parse(localStorage.getItem("invites")||"[]");
    const wrap=$("#histList"); wrap.innerHTML="";
    if(!list.length){ wrap.innerHTML="<div class='sub'>まだ履歴はありません。</div>"; return; }
    list.forEach(inv=>{
      const row=document.createElement("div"); row.className="row";
      const left=`<div class="mono" style="word-break:break-all">${inv.url}</div><small>期限：${new Date(inv.expiresAt).toLocaleString()}</small>`;
      const btn=`<button class="btn btn--sm">コピー</button>`;
      row.innerHTML=`<div>${left}</div><div>${btn}</div>`;
      row.querySelector("button").onclick=async()=>{ try{ await navigator.clipboard.writeText(inv.url); row.querySelector("button").textContent="コピー済み"; setTimeout(()=>row.querySelector("button").textContent="コピー",1000);}catch(e){} };
      wrap.appendChild(row);
    });
  }

  // 問い合わせ
  $("#qSend").addEventListener("click", ()=>{
    const msg=($("#qBody").value||"").trim(); if(!msg){ alert("内容を入力してください"); return; }
    const list=JSON.parse(localStorage.getItem("notifications")||"[]");
    list.unshift({id:String(Date.now()), ts:Date.now(), type:"system", text:`お問い合わせを受け付けました。\n内容：${msg.slice(0,200)}`});
    localStorage.setItem("notifications", JSON.stringify(list));
    $("#qBody").value=""; alert("送信しました（デモ）");
  });

  // 初期化
  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      await liff.init({ liffId: APP.LIFF_ID, withLoginOnExternalBrowser: true });
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
      const prof=await liff.getProfile(); ensureAppUID(prof.userId||"");
    }catch(e){ console.warn(e); }
    renderUID(); renderProfileView(); renderKyc(); renderHistory();
  });
</script>
</body>
</html>
