<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>LIFF Minimal｜マイページ</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --radius:16px; --fs:13px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
    line-height:1.6;overflow-x:hidden;font-size:var(--fs);
    writing-mode:horizontal-tb!important;-webkit-writing-mode:horizontal-tb!important;text-orientation:mixed!important;
    touch-action:manipulation;
  }
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px 112px}
  header{position:sticky;top:0;z-index:20;background:var(--bg);padding:10px 16px}
  .hrow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ttl{font-weight:800;font-size:18px}
  .sub{color:var(--muted);font-size:var(--fs)}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 14px;border-radius:12px;font-size:var(--fs);cursor:pointer}
  .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  .row{display:flex;gap:8px;align-items:center}
  label{display:block;margin:8px 0 4px;font-weight:700}
  input,select,textarea{width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;font-size:var(--fs)}
  textarea{min-height:80px}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-weight:700}
  .ok{background:#ecfdf5;color:#065f46;border:1px solid #86efac}
  .ng{background:#fff1f2;color:#7f1d1d;border:1px solid #fecaca}
  .list{padding-left:0;list-style:none;margin:8px 0 0}
  .list li{padding:8px 0;border-bottom:1px dashed var(--border)}
  .tabbar{position:fixed;left:0;right:0;bottom:0;height:96px;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:18px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;min-height:76px;text-align:center;font-size:var(--fs)}
  .tabicon{width:24px;height:24px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="ttl">マイページ</div>
    <span class="sub" id="uidBox">UID: —</span>
    <button class="btn" id="copyUID">コピー</button>
  </div>
</header>

<main class="wrap">
  <!-- プロフィール -->
  <section class="card" id="profCard">
    <div class="hrow" style="justify-content:space-between">
      <div class="ttl" style="font-size:16px">プロフィール</div>
      <div class="row">
        <button class="btn" id="editBtn">編集</button>
        <button class="btn primary" id="saveBtn" style="display:none">保存</button>
        <button class="btn" id="cancelBtn" style="display:none">キャンセル</button>
      </div>
    </div>

    <!-- 表示モード -->
    <div id="profView">
      <ul class="list">
        <li><b>ニックネーム</b>：<span id="vName">—</span></li>
        <li><b>年齢</b>：<span id="vAge">—</span></li>
        <li><b>エリア</b>：<span id="vArea">—</span></li>
        <li><b>趣味</b>：<span id="vHobby">—</span></li>
        <li><b>好きなこと</b>：<span id="vLike">—</span></li>
        <li><b>普段何してる</b>：<span id="vDaily">—</span></li>
        <li><b>仕事</b>：<span id="vJob">—</span></li>
        <li><b>学校</b>：<span id="vSchool">—</span></li>
        <li><b>自由記入</b>：<span id="vFree">—</span></li>
      </ul>
    </div>

    <!-- 編集モード -->
    <div id="profEdit" style="display:none">
      <label>ニックネーム（必須）</label><input id="pName" />
      <label>年齢（必須）</label><input id="pAge" type="number" min="18" max="99" />
      <label>エリア（必須）</label>
      <select id="pArea">
        <option value="">選択してください</option>
        <option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option>
        <option>名古屋</option><option>大阪</option><option>福岡</option>
      </select>
      <label>趣味</label><input id="pHobby" />
      <label>好きなこと</label><input id="pLike" />
      <label>普段何してる</label><input id="pDaily" />
      <label>仕事</label><input id="pJob" />
      <label>学校</label><input id="pSchool" />
      <label>自由記入</label><textarea id="pFree"></textarea>
    </div>
  </section>

  <!-- 本人確認（KYC） -->
  <section class="card" id="kycCard">
    <div class="ttl" style="font-size:16px">本人確認</div>
    <div class="row" style="gap:8px;margin:6px 0">
      <span id="kycBadge" class="badge ng">未完了</span>
      <span class="sub">※ デモ：性別を選ぶと完了扱い</span>
    </div>

    <div class="row" style="gap:8px;flex-wrap:wrap">
      <button class="btn" data-kyc-gender="female">女性として確認</button>
      <button class="btn" data-kyc-gender="male">男性として確認</button>
      <button class="btn" id="kycReset">再撮影（やり直し）</button>
    </div>
    <p class="sub" style="margin-top:6px">※ 本番では外部 eKYC を起動します。</p>
  </section>

  <!-- 履歴（過去に発行した招待URL） -->
  <section class="card">
    <div class="ttl" style="font-size:16px">履歴</div>
    <ul id="histList" class="list"></ul>
    <p id="histEmpty" class="sub">まだ履歴がありません。</p>
  </section>

  <!-- 問い合わせ -->
  <section class="card">
    <div class="ttl" style="font-size:16px">お問い合わせ</div>
    <p class="sub">ご不明点は下記からご連絡ください。</p>
    <div class="row" style="gap:8px">
      <button class="btn" onclick="location.href='mailto:support@example.com'">メールで問い合わせ</button>
      <button class="btn" onclick="liff.openWindow({url:'https://line.me/R/ti/p/@your_official', external:true})">LINE公式を開く</button>
    </div>
  </section>
</main>

<nav class="tabbar">
  <a href="index.html"><span class="tabicon"></span>ホーム</a>
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a class="active" href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  // ズーム無効
  window.addEventListener('gesturestart', e => e.preventDefault());

  const $=s=>document.querySelector(s);
  const getProf =()=> JSON.parse(localStorage.getItem('profile') || '{}');
  const setProf =v => localStorage.setItem('profile', JSON.stringify(v));
  const getKyc  =()=> JSON.parse(localStorage.getItem('kyc') || '{}');
  const setKyc  =v => localStorage.setItem('kyc', JSON.stringify(v));

  function renderUID(){
    const uid = localStorage.getItem('appUID') || '—';
    $("#uidBox").textContent = "UID: " + uid;
  }

  function renderProfileView(){
    const p=getProf();
    $("#vName").textContent  = p.name  || '—';
    $("#vAge").textContent   = p.age   || '—';
    $("#vArea").textContent  = p.area  || '—';
    $("#vHobby").textContent = p.hobby || '—';
    $("#vLike").textContent  = p.like  || '—';
    $("#vDaily").textContent = p.daily || '—';
    $("#vJob").textContent   = p.job   || '—';
    $("#vSchool").textContent= p.school|| '—';
    $("#vFree").textContent  = p.free  || '—';
  }
  function openEdit(){
    const p=getProf();
    $("#pName").value = p.name||''; $("#pAge").value = p.age||''; $("#pArea").value=p.area||'';
    ["Hobby","Like","Daily","Job","School","Free"].forEach(k=>{
      const key=k.toLowerCase(); const el=$("#p"+k); if(el) el.value = p[key]||'';
    });
    $("#profView").style.display="none";
    $("#editBtn").style.display="none";
    $("#saveBtn").style.display=""; $("#cancelBtn").style.display="";
    $("#profEdit").style.display="";
  }
  function closeEdit(){
    $("#profEdit").style.display="none";
    $("#saveBtn").style.display="none"; $("#cancelBtn").style.display="none";
    $("#editBtn").style.display=""; $("#profView").style.display="";
  }

  /* 保存 */
  $("#saveBtn").addEventListener('click', ()=>{
    const p={
      name: $("#pName").value.trim(),
      age:  $("#pAge").value.trim(),
      area: $("#pArea").value.trim(),
      hobby: $("#pHobby").value.trim(),
      like:  $("#pLike").value.trim(),
      daily: $("#pDaily").value.trim(),
      job:   $("#pJob").value.trim(),
      school:$("#pSchool").value.trim(),
      free:  $("#pFree").value.trim()
    };
    if(!p.name || !p.age || !p.area){ alert("ニックネーム・年齢・エリアは必須です。"); return; }
    setProf(p); renderProfileView(); closeEdit();
    SYNC.syncNow(); // 同期
  });
  $("#editBtn").onclick=openEdit;
  $("#cancelBtn").onclick=()=>{ closeEdit(); };

  /* KYC */
  function renderKyc(){
    const k=getKyc();
    const badge=$("#kycBadge");
    if(k && k.verified){
      badge.textContent = `完了（${k.gender==='female'?'女性':'男性'}）`;
      badge.className="badge ok";
    }else{
      badge.textContent = "未完了";
      badge.className="badge ng";
    }
  }
  document.querySelectorAll('[data-kyc-gender]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const v=el.dataset.kycGender;
      setKyc({verified:true, gender:v});
      renderKyc();
      SYNC.syncNow(); // 同期
    });
  });
  $("#kycReset").addEventListener('click', ()=>{ setKyc({verified:false}); renderKyc(); SYNC.syncNow(); });

  /* 履歴（招待URL） */
  function renderHistory(){
    const list=JSON.parse(localStorage.getItem("invites")||"[]");
    const ul=$("#histList"), empty=$("#histEmpty");
    ul.innerHTML=""; if(!list.length){ empty.style.display="block"; return; } empty.style.display="none";
    list.forEach(i=>{
      const li=document.createElement('li');
      li.innerHTML=`<div class="row" style="justify-content:space-between">
        <span>${i.url}</span>
        <button class="btn" onclick="navigator.clipboard.writeText('${i.url}')">コピー</button></div>
        <div class="sub">期限：${new Date(i.expiresAt).toLocaleString()}</div>`;
      ul.appendChild(li);
    });
  }

  /* UIDコピー */
  $("#copyUID").addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(localStorage.getItem('appUID')||''); $("#copyUID").textContent="コピー済み"; setTimeout(()=>$("#copyUID").textContent="コピー",1000); }catch(e){}
  });

  document.addEventListener('DOMContentLoaded', async ()=>{
    renderUID(); renderProfileView(); renderKyc(); renderHistory();

    // LIFFプロフィールから初回UID生成＆同期
    try{
      await liff.init({ liffId:"2008178197-ELrxabO9", withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
      const prof=await liff.getProfile();
      if(prof?.userId && !localStorage.getItem('appUID')){
        /* 同じハッシュ式を再利用 */
        let h=5381; for(let i=0;i<prof.userId.length;i++){ h=((h<<5)+h) ^ prof.userId.charCodeAt(i); }
        const uid="GX-"+(h>>>0).toString(36).toUpperCase().padStart(7,'0');
        localStorage.setItem('appUID', uid);
        renderUID();
      }
      SYNC.syncOnLogin(prof);
    }catch(e){ console.warn(e); }
  });
</script>
</body>
</html>
