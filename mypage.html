<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>LIFF Minimal｜マイページ</title>
<meta name="theme-color" content="#F6F3EE" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="api.js"></script>
<style>
  :root{
    --bg:#F6F3EE; --card:#FFF; --ink:#1F2937; --muted:#6B7280; --accent:#0C7C59;
    --border:#E5E7EB; --radius:16px; --tabbarH:88px; --fs:14px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
    line-height:1.6;font-size:var(--fs);overflow-x:hidden;touch-action:manipulation;
    writing-mode:horizontal-tb!important;-webkit-writing-mode:horizontal-tb!important;text-orientation:mixed!important;
  }
  header{position:sticky;top:0;z-index:10;background:var(--bg);padding:12px 16px 8px}
  .ttl{font-weight:800;font-size:18px}.sub{color:var(--muted);font-size:12px}
  .wrap{max-width:720px;margin:0 auto;padding:12px 16px calc(var(--tabbarH) + 20px)}
  .card{background:#FFF;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;box-shadow:0 4px 12px rgba(0,0,0,.04);margin-bottom:12px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;border-radius:12px;padding:10px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.small{padding:8px 10px;font-size:12px}
  .row{display:flex;align-items:center;gap:10px}.between{justify-content:space-between}
  .kv{display:grid;grid-template-columns:100px 1fr;gap:8px;align-items:center}
  .label{color:var(--muted);font-size:12px}
  .pill{display:inline-flex;align-items:center;justify-content:center;min-width:56px;padding:6px 10px;border-radius:999px;background:#E7EFE7;color:#10381F;font-weight:700}
  .ok{background:#E7F5ED;color:#065F46}.warn{background:#FEF3C7;color:#92400E}.gray{background:#F3F4F6;color:#111827}
  input,select,textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;font-size:16px}
  textarea{min-height:90px}
  .urlbox{padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:#FAFAF7;word-break:break-all}
  nav.tabbar{position:fixed;left:0;right:0;bottom:0;height:var(--tabbarH);background:rgba(255,255,255,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;z-index:30;padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
  .tabbar a{flex:1;text-decoration:none;color:#6B7280;padding:16px 6px;display:flex;flex-direction:column;gap:6px;align-items:center;text-align:center}
  .tabicon{width:22px;height:22px;border-radius:6px;background:#CBD5CB}
  .tabbar .active{color:#0d3a23;font-weight:800}.tabbar .active .tabicon{background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="ttl">マイページ</div>
  <div class="sub" id="siteSub"></div>
</header>

<main class="wrap">
  <!-- UID -->
  <section class="card">
    <div class="row between">
      <div class="row" style="gap:8px">
        <div class="label">UID</div>
        <div id="uidText" style="font-weight:700">—</div>
      </div>
      <button id="copyUid" class="btn small">コピー</button>
    </div>
  </section>

  <!-- プロフィール（表示） -->
  <section class="card" id="profView">
    <div class="row between">
      <div style="font-weight:700">プロフィール</div>
      <button id="editBtn" class="btn small">編集</button>
    </div>
    <div class="kv"><div class="label">ニックネーム</div><div id="v_name">—</div></div>
    <div class="kv"><div class="label">年齢</div><div id="v_age">—</div></div>
    <div class="kv"><div class="label">エリア</div><div id="v_area">—</div></div>
  </section>

  <!-- プロフィール（編集） -->
  <section class="card" id="profEdit" style="display:none">
    <div class="row between"><div style="font-weight:700">プロフィールを編集</div></div>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <div style="flex:1 1 220px"><div class="label">ニックネーム（必須）</div><input id="f_name" /></div>
      <div style="width:120px"><div class="label">年齢（必須）</div><input id="f_age" type="number" min="18" max="80"/></div>
      <div style="flex:1 1 200px"><div class="label">エリア（必須）</div>
        <select id="f_area">
          <option value="">選択してください</option>
          <option>東京</option><option>神奈川</option><option>千葉</option><option>埼玉</option>
          <option>名古屋</option><option>大阪</option><option>福岡</option>
        </select>
      </div>
    </div>
    <div class="row" style="gap:12px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1 1 240px"><div class="label">趣味</div><input id="f_hobby" /></div>
      <div style="flex:1 1 240px"><div class="label">好きなこと</div><input id="f_like" /></div>
      <div style="flex:1 1 240px"><div class="label">普段何してる</div><input id="f_usually" /></div>
      <div style="flex:1 1 240px"><div class="label">仕事</div><input id="f_job" /></div>
      <div style="flex:1 1 240px"><div class="label">学校</div><input id="f_school" /></div>
    </div>
    <div style="margin-top:8px"><div class="label">自由記入</div><textarea id="f_free"></textarea></div>
    <div class="row between" style="margin-top:10px">
      <button id="cancelBtn" class="btn">キャンセル</button>
      <button id="saveBtn" class="btn primary">保存する</button>
    </div>
    <div class="label" id="saveHint" style="display:none;margin-top:6px">保存しました。</div>
  </section>

  <!-- 本人確認 -->
  <section class="card" id="kycCard">
    <div class="row between">
      <div style="font-weight:700">本人確認</div>
      <span id="kycPill" class="pill warn">未完了</span>
    </div>
    <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap">
      <button class="btn" id="asFemale">女性として確認</button>
      <button class="btn" id="asMale">男性として確認</button>
      <button class="btn" id="kycReset">再撮影（やり直し）</button>
    </div>
    <div class="label" id="kycGender" style="margin-top:6px">—</div>
  </section>

  <!-- クレジット残高 -->
  <section class="card" id="creditCard">
    <div class="row between">
      <div style="font-weight:700">クレジット残高</div>
      <div style="font-size:28px;font-weight:800"><span id="credit">0</span> <span class="label">pt</span></div>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button class="btn" id="chargeBtn">チャージ</button>
    </div>
    <div id="chargePanel" class="label" style="display:none;margin-top:8px">
      <div class="row" style="gap:8px;align-items:center">
        <select id="chargeAmount">
          <option value="500">+500 pt</option>
          <option value="1000" selected>+1,000 pt</option>
          <option value="3000">+3,000 pt</option>
          <option value="5000">+5,000 pt</option>
        </select>
        <button class="btn" id="chargeDo">チャージ実行</button>
      </div>
      <div class="label" style="margin-top:6px">※ デモ：即時で残高に反映します</div>
    </div>
  </section>

  <!-- 履歴（現在の招待URL＆期限を先頭に） -->
  <section class="card" id="histCard">
    <div style="font-weight:700">履歴</div>
    <div class="urlbox" id="currentInvite" style="margin-top:8px">— 現在の招待：未発行 —</div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button class="btn small" id="copyInvite">URLコピー</button>
    </div>
    <div class="label" style="margin-top:10px">過去の発行履歴</div>
    <div id="histList" class="label" style="margin-top:4px">— まだ履歴がありません —</div>
  </section>

  <!-- お知らせ（下） -->
  <section class="card" id="notiCard">
    <div class="row between">
      <div style="font-weight:700">お知らせ</div>
      <button class="btn small" id="clearNoti">クリア</button>
    </div>
    <div id="notiList" class="label" style="margin-top:8px">—</div>
  </section>

  <!-- お問い合わせ（最下部） -->
  <section class="card" id="contactCard">
    <div style="font-weight:700">お問い合わせ</div>
    <p class="label" style="margin-top:6px">ご不明点は下記からご連絡ください。</p>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <a class="btn" href="mailto:support@example.com">メールで問い合わせ</a>
      <a class="btn" href="https://line.me/R/ti/p/@your_official" target="_blank" rel="noopener">LINE公式を開く</a>
    </div>
  </section>
</main>

<nav class="tabbar">
  <a href="apply.html"><span class="tabicon"></span>申込み</a>
  <a class="active" href="mypage.html"><span class="tabicon"></span>マイページ</a>
</nav>

<script>
  const $=s=>document.querySelector(s);
  const j=(k)=>JSON.parse(localStorage.getItem(k)||'null');
  const g=(k)=>localStorage.getItem(k);
  const sset=(k,val)=>localStorage.setItem(k, typeof val==='string'? val: JSON.stringify(val));

  // --- LIFF ログインループ対策 ---
  const LOGIN_GUARD_KEY='LIFF_LOGIN_TRIED';
  const SYNC_SENT_KEY='SYNC_LOGIN_SENT';
  async function initLiffSafely(){
    try{
      await liff.init({ liffId:(window.APP&&APP.LIFF_ID)||'', withLoginOnExternalBrowser:true });

      const inClient = liff.isInClient();
      const loggedIn = liff.isLoggedIn();

      if(!inClient && !loggedIn){
        if(!sessionStorage.getItem(LOGIN_GUARD_KEY)){
          sessionStorage.setItem(LOGIN_GUARD_KEY,'1');
          const redirect = location.origin + location.pathname;
          liff.login({ redirectUri: redirect });
          return false;
        }else{
          console.warn('Skip liff.login to avoid loop');
          return false;
        }
      }
      sessionStorage.removeItem(LOGIN_GUARD_KEY);

      if(window.SYNC && SYNC.syncOnLogin && !sessionStorage.getItem(SYNC_SENT_KEY)){
        const prof = await liff.getProfile().catch(()=>null);
        await SYNC.syncOnLogin(prof||{});
        sessionStorage.setItem(SYNC_SENT_KEY,'1');
      }
      return true;
    }catch(e){
      console.warn('LIFF init error', e);
      return false;
    }
  }

  function renderUID(){ $('#uidText').textContent = g('uid') || '—'; }
  function renderProfile(){
    const p=j('profile')||{};
    const name = p.name ?? g('prof.name') ?? '—';
    const age  = p.age  ?? g('prof.age')  ?? '—';
    const area = p.area ?? g('prof.area') ?? '—';
    $('#v_name').textContent = name || '—';
    $('#v_age').textContent  = age  || '—';
    $('#v_area').textContent = area || '—';
  }
  function fillForm(){
    const p=j('profile')||{};
    $('#f_name').value = (p.name ?? g('prof.name') ?? '');
    $('#f_age').value  = (p.age  ?? g('prof.age')  ?? '');
    $('#f_area').value = (p.area ?? g('prof.area') ?? '');
    $('#f_hobby').value   = p.hobby   ?? g('prof.hobby')   ?? '';
    $('#f_like').value    = p.like    ?? g('prof.like')    ?? '';
    $('#f_usually').value = p.usually ?? g('prof.usually') ?? '';
    $('#f_job').value     = p.job     ?? g('prof.job')     ?? '';
    $('#f_school').value  = p.school  ?? g('prof.school')  ?? '';
    $('#f_free').value    = p.free    ?? g('prof.free')    ?? '';
  }
  function toggleEdit(on){
    $('#profView').style.display = on?'none':'block';
    $('#profEdit').style.display = on?'block':'none';
    if(on) fillForm();
  }
  async function saveProfile(){
    const profile = {
      name:($('#f_name').value||'').trim(),
      age:($('#f_age').value||'').trim(),
      area:($('#f_area').value||'').trim(),
      hobby:($('#f_hobby').value||'').trim(),
      like:($('#f_like').value||'').trim(),
      usually:($('#f_usually').value||'').trim(),
      job:($('#f_job').value||'').trim(),
      school:($('#f_school').value||'').trim(),
      free:($('#f_free').value||'').trim()
    };
    if(!profile.name||!profile.age||!profile.area){ alert('ニックネーム・年齢・エリアは必須です。'); return; }
    sset('profile', profile);
    sset('prof.name', profile.name); sset('prof.age', profile.age); sset('prof.area', profile.area);
    sset('prof.hobby', profile.hobby); sset('prof.like', profile.like); sset('prof.usually', profile.usually);
    sset('prof.job', profile.job); sset('prof.school', profile.school); sset('prof.free', profile.free);

    try{
      if(window.SYNC && SYNC.upsertUser){
        await SYNC.upsertUser({
          uid: g('uid')||'',
          profile,
          credit: Number(g('credit')||0),
          kyc: {verified: g('kyc.verified')==='true', gender: g('kyc.gender')||''}
        });
      }
    }catch(e){ console.warn(e); }
    renderProfile();
    $('#saveHint').style.display='block'; setTimeout(()=>$('#saveHint').style.display='none',1400);
    toggleEdit(false);
  }

  function renderKyc(){
    const k = j('kyc') || {verified: g('kyc.verified')==='true', gender: g('kyc.gender')||''};
    $('#kycPill').textContent = k.verified?'完了':'未完了';
    $('#kycPill').className = 'pill ' + (k.verified?'ok':'warn');
    $('#kycGender').textContent = k.verified ? (k.gender==='female'?'女性':'男性') : '—';
  }
  function setKyc(gender){
    if(gender){ sset('kyc', {verified:true, gender}); sset('kyc.verified','true'); sset('kyc.gender',gender); }
    else{ sset('kyc', {verified:false, gender:''}); sset('kyc.verified','false'); sset('kyc.gender',''); }
    renderKyc();
  }

  function setCredit(vl){ localStorage.setItem('credit', String(vl)); $('#credit').textContent = vl; }
  function renderCredit(){ $('#credit').textContent = Number(g('credit')||0); }

  function getNoti(){ return j('noti.items') || j('notifications') || []; }
  function setNoti(arr){ sset('noti.items', arr); sset('notifications', arr); }
  function renderNoti(){
    const arr=getNoti();
    if(!arr.length){ $('#notiList').textContent='— まだお知らせはありません —'; return; }
    $('#notiList').innerHTML = arr.map(n=>`<div>・${(n.date||'').toString()}：${n.text||''}</div>`).join('');
  }

  function formatRemain(iso){
    if(!iso) return '—';
    const d = new Date(iso+'T00:00:00'); const today=new Date(); d.setHours(0,0,0,0); today.setHours(0,0,0,0);
    const diff = Math.ceil((d-today)/86400000);
    return diff>=0? `残り ${diff}日` : '期限切れ';
  }
  function renderInvites(){
    const cur = j('invite.current') || {url:'', expire:''};
    $('#currentInvite').innerHTML = cur.url ? (`<div>現在の招待URL：<b style="word-break:break-all">${cur.url}</b></div><div class="label">期限：${cur.expire||'—'}（${formatRemain(cur.expire)}）</div>`)
                                             : '— 現在の招待：未発行 —';
    const hist = j('invite.history') || [];
    $('#histList').innerHTML = hist.length ? hist.map(x=>`<div>・${x.date||''}　${x.url||''}</div>`).join('')
                                           : '— まだ履歴がありません —';
  }

  // クリック
  $('#copyUid').addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText($('#uidText').textContent||''); alert('UIDをコピーしました'); }catch{} });
  $('#editBtn').addEventListener('click',()=>toggleEdit(true));
  $('#cancelBtn').addEventListener('click',()=>toggleEdit(false));
  $('#saveBtn').addEventListener('click',saveProfile);
  $('#asFemale').addEventListener('click',()=>setKyc('female'));
  $('#asMale').addEventListener('click',()=>setKyc('male'));
  $('#kycReset').addEventListener('click',()=>setKyc(''));
  $('#chargeBtn').addEventListener('click',()=>$('#chargePanel').style.display = $('#chargePanel').style.display==='none'?'block':'none');
  $('#chargeDo').addEventListener('click',()=>{
    const add = Number($('#chargeAmount').value||0);
    const cur = Number(g('credit')||0);
    const next = cur + add; setCredit(next);
    const arr=getNoti(); arr.unshift({date:new Date().toISOString().slice(0,19).replace('T',' '), text:`${add} pt をチャージしました（残高：${next} pt）`});
    setNoti(arr); renderNoti();
  });
  $('#clearNoti').addEventListener('click',()=>{ setNoti([]); renderNoti(); });
  $('#copyInvite').addEventListener('click',async()=>{
    const cur = j('invite.current') || {};
    if(!cur.url){ alert('現在の招待URLがありません'); return; }
    try{ await navigator.clipboard.writeText(cur.url); alert('招待URLをコピーしました'); }catch{}
  });

  document.addEventListener('DOMContentLoaded', async ()=>{
    $('#siteSub').textContent = location.hostname.replace(/^www\./,'');
    const ok = await initLiffSafely();
    if(!ok) return;

    renderUID(); renderProfile(); renderKyc(); renderCredit(); renderInvites(); renderNoti();
  });
</script>
</body>
</html>
